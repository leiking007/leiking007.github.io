---
title: "å¸¸ç”¨è„šæœ¬å’Œé…ç½®"
date: 2025-04-26
lastmod: 2025-04-26
draft: false
tags: ['æœåŠ¡å™¨']
categories: ["ğŸ§æœåŠ¡å™¨è¿ç»´"]
author: "lei"
summary: "åŒ…å«ç¬”è®°è‡ªåŠ¨æ›´æ–°éƒ¨ç½²è„šæœ¬ï¼ˆå¦‚ autorun.sh ç­‰ï¼‰ã€Python å’Œ Java ç¨‹åºå¯åŠ¨è„šæœ¬ï¼Œä»¥åŠå¼€æœºè‡ªå¯é…ç½®å’Œ Windows å¯åŠ¨è„šæœ¬ï¼Œç”¨äºè‡ªåŠ¨åŒ–éƒ¨ç½²ä¸è¿è¡Œç®¡ç†ã€‚"
---

# å¸¸ç”¨è„šæœ¬å’Œé…ç½®

## ç¬”è®°è‡ªåŠ¨æ›´æ–°éƒ¨ç½²

### autorun

`autorun.sh`

```shell
#!/bin/bash

# è®¾ç½®ç¯å¢ƒå˜é‡
export PATH=/opt/mime/soft/hugo_extended_0.139.2:/opt/mime/soft/nginx/sbin:$PATH
export NVM_DIR="/opt/mime/soft/nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion

# æ£€æµ‹ç½‘ç»œç¯å¢ƒï¼Œæ— å¤–ç½‘ç¡çœ 3ç§’ç»§ç»­æ‰§è¡Œ
while !(ping -c 4 8.8.8.8 &> /dev/null;) do
    echo "ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œç­‰å¾…3ç§’ä¸‹æ¬¡æ£€æµ‹"
    sleep 3
done

echo "ç½‘ç»œè¿æ¥æ­£å¸¸ã€‚"

# å¯åŠ¨nginx
nginx

# ddns
nohup /opt/mime/py/venv/bin/python -u /opt/mime/py/t_ddns.py > /opt/mime/py/log/t_ddns.log 2>&1 &
# è‡ªåŠ¨æ£€æµ‹note gitä»“åº“ï¼Œå¹¶æ›´æ–°å’Œæ„å»º
nohup sh /opt/mime/script/autoUpdateNote.sh > /opt/mime/py/log/autoUpdateNote.log 2>&1 &
```

### autoUpdateNote

`autoUpdateNote.sh`

```shell
#!/bin/sh

# é¡¹ç›®ç›®å½•
path="/opt/mime/git/note_hugo"

# å®šæ—¶æ›´æ–°gité¡¹ç›®ã€å¹¶æ‰“å°ç»“æœ
pull_git() {
    echo "$(date +"%Y-%m-%d %H:%M:%S"): å¼€å§‹æ›´æ–°ç¨‹åº"

    # æ›´æ–°gitåº“
    res=$(git -C "$path" pull 2>&1)

    echo "å½“å‰æ“ä½œç³»ç»Ÿ: $(uname)"
    echo "æ›´æ–°ç»“æœ: $res"  # æ ‡å‡†è¾“å‡º



    # æ›´æ–°ç¨‹åº
    case "$res" in
        *"Already up to date"*)
            echo "Already up to date."
            ;;
        *"Updating"*)
            cd "$path/themes/hugo-tl" || { echo "æ— æ³•åˆ‡æ¢åˆ°ç›®å½•: $path/themes/hugo-tl"; exit 1; }
            res=$(yarn install  2>&1)
            echo "yarn install result: $res"
            res=$(yarn run build 2>&1)
            echo "yarn run build result: $res"
            ;;
        *)
            echo "update failed."
            ;;
    esac
}

# å¼€å§‹æ‰§è¡Œç¨‹åºï¼Œæ¯éš”30ç§’æ‰§è¡Œä¸€æ¬¡
while true; do
    pull_git
    echo "$(date +"%Y-%m-%d %H:%M:%S"): æ›´æ–°ç¨‹åºç»“æŸ, ä¼‘çœ ä¸­..."
    sleep 30

```

### t_ddns

`t_ddns.py`

```python
import json
import time
import socket
from tencentcloud.common import credential
from tencentcloud.common.profile.client_profile import ClientProfile
from tencentcloud.common.profile.http_profile import HttpProfile
from tencentcloud.common.exception.tencent_cloud_sdk_exception import (
    TencentCloudSDKException,
)
from tencentcloud.dnspod.v20210323 import dnspod_client, models

# å®‰è£…ä¾èµ– pip install -i https://mirrors.tencent.com/pypi/simple/ --upgrade tencentcloud-sdk-python


# è·å–æœ¬åœ° IPv6 åœ°å€
def get_local_ipv6():
    try:
        s = socket.socket(socket.AF_INET6, socket.SOCK_DGRAM)
        s.connect(
            ("2001:4860:4860::8888", 80)
        )  # ä½¿ç”¨ä¸€ä¸ªå…¬å…±çš„IPv6åœ°å€ï¼ˆè¿™é‡Œæ˜¯è°·æ­Œçš„DNSæœåŠ¡å™¨IPv6åœ°å€ï¼‰
        local_ipv6 = s.getsockname()[0]
        s.close()
        return local_ipv6
    except Exception as e:
        print(f"è·å–æœ¬æœºIPv6åœ°å€æ—¶å‡ºé”™: {e}")
        return None


# æ›´æ–° IPv6 åœ°å€åˆ° DNSPod
def update_dns_ipv6(cred, dictInfo):
    try:
        # å®ä¾‹åŒ–ä¸€ä¸ªhttpé€‰é¡¹ï¼Œå¯é€‰çš„ï¼Œæ²¡æœ‰ç‰¹æ®Šéœ€æ±‚å¯ä»¥è·³è¿‡
        httpProfile = HttpProfile()
        httpProfile.endpoint = "dnspod.tencentcloudapi.com"

        # å®ä¾‹åŒ–ä¸€ä¸ªclienté€‰é¡¹ï¼Œå¯é€‰çš„ï¼Œæ²¡æœ‰ç‰¹æ®Šéœ€æ±‚å¯ä»¥è·³è¿‡
        clientProfile = ClientProfile()
        clientProfile.httpProfile = httpProfile
        # å®ä¾‹åŒ–è¦è¯·æ±‚äº§å“çš„clientå¯¹è±¡,clientProfileæ˜¯å¯é€‰çš„
        client = dnspod_client.DnspodClient(cred, "", clientProfile)

        # å®ä¾‹åŒ–ä¸€ä¸ªè¯·æ±‚å¯¹è±¡,æ¯ä¸ªæ¥å£éƒ½ä¼šå¯¹åº”ä¸€ä¸ªrequestå¯¹è±¡
        req = models.ModifyRecordRequest()
        params = {
            "Domain": dictInfo.get("Domain"),
            "RecordType": dictInfo.get("RecordType", "AAAA"),
            "RecordLine": dictInfo.get("RecordLine", "é»˜è®¤"),
            "Value": dictInfo.get("Value"),
            "RecordId": dictInfo.get("RecordId"),
            "SubDomain": dictInfo.get("SubDomain"),
        }
        req.from_json_string(json.dumps(params))

        # è¿”å›çš„respæ˜¯ä¸€ä¸ªModifyRecordResponseçš„å®ä¾‹ï¼Œä¸è¯·æ±‚å¯¹è±¡å¯¹åº”
        resp = client.ModifyRecord(req)
        # è¾“å‡ºjsonæ ¼å¼çš„å­—ç¬¦ä¸²å›åŒ…
        print(resp.to_json_string())
    except TencentCloudSDKException as err:
        print(err)


# è·å–è¿œç«¯ç°æœ‰è®°å½•ï¼ŒåŸŸåã€å­åŸŸååç§°
def get_one_record(cred, dictInfo):
    try:
        # å®ä¾‹åŒ–ä¸€ä¸ªhttpé€‰é¡¹ï¼Œå¯é€‰çš„ï¼Œæ²¡æœ‰ç‰¹æ®Šéœ€æ±‚å¯ä»¥è·³è¿‡
        httpProfile = HttpProfile()
        httpProfile.endpoint = "dnspod.tencentcloudapi.com"

        # å®ä¾‹åŒ–ä¸€ä¸ªclienté€‰é¡¹ï¼Œå¯é€‰çš„ï¼Œæ²¡æœ‰ç‰¹æ®Šéœ€æ±‚å¯ä»¥è·³è¿‡
        clientProfile = ClientProfile()
        clientProfile.httpProfile = httpProfile
        # å®ä¾‹åŒ–è¦è¯·æ±‚äº§å“çš„clientå¯¹è±¡,clientProfileæ˜¯å¯é€‰çš„
        client = dnspod_client.DnspodClient(cred, "", clientProfile)

        # å®ä¾‹åŒ–ä¸€ä¸ªè¯·æ±‚å¯¹è±¡,æ¯ä¸ªæ¥å£éƒ½ä¼šå¯¹åº”ä¸€ä¸ªrequestå¯¹è±¡
        req = models.DescribeRecordListRequest()
        params = {"Domain": dictInfo.get("Domain")}
        req.from_json_string(json.dumps(params))
        # è¿”å›çš„respæ˜¯ä¸€ä¸ªDescribeRecordListResponseçš„å®ä¾‹ï¼Œä¸è¯·æ±‚å¯¹è±¡å¯¹åº”
        resp = client.DescribeRecordList(req)
        for record in resp.RecordList:
            if record.Name == dictInfo.get("SubDomain", "-----"):
                return record
        # è¾“å‡ºjsonæ ¼å¼çš„å­—ç¬¦ä¸²å›åŒ…
        return None
    except TencentCloudSDKException as err:
        print(err)


if __name__ == "__main__":

    domain = "leilife.site"
    subDomain = "note"

    secretId = "****************************"
    secretKey = "********************************"
    # å®ä¾‹åŒ–ä¸€ä¸ªè®¤è¯å¯¹è±¡ï¼Œå…¥å‚éœ€è¦ä¼ å…¥è…¾è®¯äº‘è´¦æˆ· SecretId å’Œ SecretKeyï¼Œæ­¤å¤„è¿˜éœ€æ³¨æ„å¯†é’¥å¯¹çš„ä¿å¯†
    cred = credential.Credential(secretId, secretKey)
    print(
        time.strftime("%Y-%m-%d %H:%M:%S", time.localtime(time.time())),
        ": å¼€å§‹æ‰§è¡Œddns",
    )
    # å•æŒ‘è§£æè®°å½•
    record = get_one_record(cred, {"Domain": domain, "SubDomain": subDomain})

    while True:
        # è·å–dnsè®°å½•è§£æçš„ipåœ°å€
        remoteIp = record.Value
        # è·å–æœ¬åœ°ipåœ°å€
        localIp = get_local_ipv6()
        print("æœ¬åœ°ipåœ°å€: ", localIp)
        print("dnsè®°å½•è§£æipåœ°å€: ", remoteIp)
        if remoteIp != localIp and localIp is not None:
            print("ipåœ°å€ä¸ä¸€è‡´,éœ€è¦æ›´æ–°")
            update_dns_ipv6(
                cred, {"Domain": domain, "SubDomain": subDomain, "Value": localIp,"RecordId":record.RecordId}
            )
        elif localIp is None:
            print("æœ¬åœ°ipåœ°å€è·å–å¤±è´¥,ç¨åé‡è¯•")
        else:
            print("ipåœ°å€ä¸€è‡´,ä¸éœ€è¦æ›´æ–°")

        print(
            time.strftime("%Y-%m-%d %H:%M:%S", time.localtime(time.time())),
            ": æ›´æ–°ddnsç»“æŸ, ä¼‘çœ ä¸­...\n\n",
        )
        time.sleep(60 * 30)  # æ¯éš”30åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
```

### å¼€æœºè‡ªå¯

/etc/systemd/system/ ç›®å½•ä¸‹æ–°å»ºæœåŠ¡ `myscript.service`

```
[Unit]
Description=My Startup Script
After=network.target

[Service]
Type=forking
ExecStart=/opt/mime/script/autorun.sh

[Install]
WantedBy=multi-user.target
```

```bash
# å¼€æœºè‡ªå¯æœåŠ¡
systemctl enable myscript

# å…³é—­å¼€æœºè‡ªå¯
systemctl disable myscript

# å¯åŠ¨æœåŠ¡
systemctl start myscript

# å…³é—­æœåŠ¡
systemctl stop myscript

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
systemctl status myscript.service
```

### winStartNote

`startNote.bat`

```bat
@echo off
SET targetDir=F:\study\git\note_hugo
cd /d %targetDir%
git pull
SET targetDir=F:\study\git\note_hugo\themes\hugo-tl
cd /d %targetDir%
npm run dev
pause
```

## shè„šæœ¬

### pythonç¨‹åºå¯åŠ¨è„šæœ¬

```bash
#!/bin/bash
#--------------------------------------------------------
# Author               :tanglei
# Description          :pythonç¨‹åºå¯åŠ¨è„šæœ¬
#--------------------------------------------------------

# è„šæœ¬æ‰€åœ¨ç›®å½•ï¼Œ$0ä¸ºè„šæœ¬æ–‡ä»¶è·¯å¾„ï¼Œdirnameæå–ç›®å½•éƒ¨åˆ†
SCRIPT_DIR=$(cd "$(dirname "$0")" && pwd)
LOG_DIR="$SCRIPT_DIR/log"  # æ—¥å¿—ç›®å½•
APP_LOG="$LOG_DIR/app.log"  # åº”ç”¨æ—¥å¿—
OPERATE_LOG="$LOG_DIR/operate.log"  # æ“ä½œæ—¥å¿—

cd "$SCRIPT_DIR"

if [ ! -d "$LOG_DIR" ]; then
    mkdir -p "$LOG_DIR"
fi

# -------------- ç¯å¢ƒå˜é‡ ------------------
export PATH=$PATH:"$SCRIPT_DIR/.runtime/bin"
# -----------------------------------------

# -------------- é…ç½® ------------------
PIDFILE=".pid"                      # PIDæ–‡ä»¶
APP_FILE="main.py"                  # è„šæœ¬åï¼Œå»ºè®®ä½¿ç”¨ç‰¹å®šçš„åç§°ï¼Œå¦‚ face_main.py
# --------------------------------

start() {
    if [[ -f "$PIDFILE" ]]; then
        PID=$(cat "$PIDFILE")
        if kill -0 "$PID"; then
            echo "$APP_FILEç¨‹åºå·²åœ¨è¿è¡Œï¼ŒPID=$PID" | tee -a "$OPERATE_LOG"
            return 1
        fi
        echo "åˆ é™¤æ—§çš„PIDæ–‡ä»¶ $PIDFILE" | tee -a "$OPERATE_LOG"
        rm -f "$PIDFILE"
    fi
    echo "æ­£åœ¨å¯åŠ¨ $APP_FILE ..." | tee -a "$OPERATE_LOG"

    nohup python $APP_FILE > "$APP_LOG" 2>&1 &
    echo $! > "$PIDFILE"
    
    # ç­‰å¾…ä¸‰ç§’ï¼Œåˆ¤æ–­æ˜¯å¦å¯åŠ¨æˆåŠŸ
    sleep 3
    if [[ -f "$PIDFILE" ]]; then
        PID=$(cat "$PIDFILE")
        if kill -0 "$PID"; then
            echo "$APP_FILEç¨‹åºå¯åŠ¨æˆåŠŸï¼ŒPID=$PID" | tee -a "$OPERATE_LOG"
            return 0
        fi
    fi
    echo "$APP_FILEç¨‹åºå¯åŠ¨å¤±è´¥" | tee -a "$OPERATE_LOG"
    return 1

}

clear_log() {
    echo "æ­£åœ¨æ¸…é™¤æ—¥å¿—..." | tee -a "$OPERATE_LOG"
    > "$APP_LOG"
    echo "æ—¥å¿—æ¸…é™¤å®Œæˆ" | tee -a "$OPERATE_LOG"
}

stop() {
    if [[ ! -f "$PIDFILE" ]]; then
        echo "æ‰¾ä¸åˆ° pidfileï¼Œç¨‹åºå¯èƒ½æœªå¯åŠ¨" | tee -a "$OPERATE_LOG_FILE"
        return 1
    fi
    PID=$(cat "$PIDFILE")
    if kill -0 "$PID" 2>/dev/null; then
        echo "æ­£åœ¨åœæ­¢ $APP_FILE ..." | tee -a "$OPERATE_LOG"
        kill -9 "$PID"
        while kill -0 "$PID" 2>/dev/null; do
            sleep 1
        done
        rm -f "$PIDFILE"
        echo "$APP_FILEç¨‹åºåœæ­¢æˆåŠŸï¼ŒPID=$PID" | tee -a "$OPERATE_LOG"
        return 0
    else
        echo "PID=$PID ä¸å­˜åœ¨ï¼Œå¯èƒ½å·²åœæ­¢" | tee -a "$OPERATE_LOG"
        return 1
    fi
}

tail_log() {
    echo "æŸ¥çœ‹ $APP_FILE æ—¥å¿—..." | tee -a "$OPERATE_LOG"
    tail -500f "$APP_LOG"
    return 0
}

status() {
    if [[ -f "$PIDFILE" ]]; then
        PID=$(cat "$PIDFILE")
        if kill -0 "$PID" 2>/dev/null; then
            echo "$APP_FILEç¨‹åºæ­£åœ¨è¿è¡Œï¼ŒPID=$PID" | tee -a "$OPERATE_LOG"
        else
            echo "è¿›ç¨‹ $PID å·²é€€å‡ºï¼Œä½† pidfile ä»å­˜åœ¨" | tee -a "$OPERATE_LOG"
        fi
    else
        echo "$APP_FILEç¨‹åºæœªè¿è¡Œ" | tee -a "$OPERATE_LOG"
    fi
    return 0
}

main() {
    echo "------------------------------------------------" | tee -a "$OPERATE_LOG"
    echo "Script executed at: $(date)" | tee -a "$OPERATE_LOG"
    echo "------------------------------------------------"
    echo "1. start server"
    echo "2. stop server"
    echo "3. status"
    echo "4. tail log"
    echo "5. clear log"
    echo "------------------------------------------------"
    read -p "please choose: " choice
    case $choice in
        1) start ;;
        2) stop ;;
        3) status ;;
        4) tail_log ;;
        5) clear_log ;;
        *) exit 0 ;;
    esac
}
main
```

### javaç¨‹åºå¯åŠ¨è„šæœ¬

```bash
#!/bin/bash
#--------------------------------------------------------
# Author               :tanglei
# Description          :javaç¨‹åºå¯åŠ¨è„šæœ¬
#--------------------------------------------------------

# è„šæœ¬æ‰€åœ¨ç›®å½•ï¼Œ$0ä¸ºè„šæœ¬æ–‡ä»¶è·¯å¾„ï¼Œdirnameæå–ç›®å½•éƒ¨åˆ†
SCRIPT_DIR=$(cd "$(dirname "$0")" && pwd)
LOG_DIR="$SCRIPT_DIR/log"  # æ—¥å¿—ç›®å½•
APP_LOG="$LOG_DIR/app.log"  # åº”ç”¨æ—¥å¿—
OPERATE_LOG="$LOG_DIR/operate.log"  # æ“ä½œæ—¥å¿—

cd "$SCRIPT_DIR"

if [ ! -d "$LOG_DIR" ]; then
    mkdir -p "$LOG_DIR"
fi

# -------------- ç¯å¢ƒå˜é‡ ------------------
# export PATH=$PATH:/data/enviroment/jdk1.8.0_461/bin
# -----------------------------------------

# -------------- é…ç½® ------------------
PIDFILE=".pid"                      # PIDæ–‡ä»¶
APP_FILE="app.jar"                  # åº”ç”¨jaråŒ…
JAVA_OPTS="-Xms256m -Xmx512m"       # JVMå‚æ•°
JAR_OPTS="--server.port=8000"       # åº”ç”¨å‚æ•°
# --------------------------------

start() {
    if [[ -f "$PIDFILE" ]]; then
        PID=$(cat "$PIDFILE")
        if kill -0 "$PID"; then
            echo "$APP_FILEç¨‹åºå·²åœ¨è¿è¡Œï¼ŒPID=$PID" | tee -a "$OPERATE_LOG"
            return 1
        fi
        echo "åˆ é™¤æ—§çš„PIDæ–‡ä»¶ $PIDFILE" | tee -a "$OPERATE_LOG"
        rm -f "$PIDFILE"
    fi
    echo "æ­£åœ¨å¯åŠ¨ $JAR_FILE ..." | tee -a "$OPERATE_LOG"

    nohup java $JAVA_OPTS -jar $APP_FILE $JAR_OPTS > "$APP_LOG" 2>&1 &
    echo $! > "$PIDFILE"
    
    # ç­‰å¾…ä¸‰ç§’ï¼Œåˆ¤æ–­æ˜¯å¦å¯åŠ¨æˆåŠŸ
    sleep 3
    if [[ -f "$PIDFILE" ]]; then
        PID=$(cat "$PIDFILE")
        if kill -0 "$PID"; then
            echo "$APP_FILEç¨‹åºå¯åŠ¨æˆåŠŸï¼ŒPID=$PID" | tee -a "$OPERATE_LOG"
            return 0
        fi
    fi
    echo "$APP_FILEç¨‹åºå¯åŠ¨å¤±è´¥" | tee -a "$OPERATE_LOG"
    return 1

}

clear_log() {
    echo "æ­£åœ¨æ¸…é™¤æ—¥å¿—..." | tee -a "$OPERATE_LOG"
    > "$APP_LOG"
    echo "æ—¥å¿—æ¸…é™¤å®Œæˆ" | tee -a "$OPERATE_LOG"
}

stop() {
    if [[ ! -f "$PIDFILE" ]]; then
        echo "æ‰¾ä¸åˆ° pidfileï¼Œç¨‹åºå¯èƒ½æœªå¯åŠ¨" | tee -a "$OPERATE_LOG_FILE"
        return 1
    fi
    PID=$(cat "$PIDFILE")
    if kill -0 "$PID" 2>/dev/null; then
        echo "æ­£åœ¨åœæ­¢ $APP_FILE ..." | tee -a "$OPERATE_LOG"
        kill -9 "$PID"
        while kill -0 "$PID" 2>/dev/null; do
            sleep 1
        done
        rm -f "$PIDFILE"
        echo "$APP_FILEç¨‹åºåœæ­¢æˆåŠŸï¼ŒPID=$PID" | tee -a "$OPERATE_LOG"
        return 0
    else
        echo "PID=$PID ä¸å­˜åœ¨ï¼Œå¯èƒ½å·²åœæ­¢" | tee -a "$OPERATE_LOG"
        return 1
    fi
}

tail_log() {
    echo "æŸ¥çœ‹ $APP_FILE æ—¥å¿—..." | tee -a "$OPERATE_LOG"
    tail -500f "$APP_LOG"
    return 0
}

status() {
    if [[ -f "$PIDFILE" ]]; then
        PID=$(cat "$PIDFILE")
        if kill -0 "$PID" 2>/dev/null; then
            echo "$APP_FILEç¨‹åºæ­£åœ¨è¿è¡Œï¼ŒPID=$PID" | tee -a "$OPERATE_LOG"
        else
            echo "è¿›ç¨‹ $PID å·²é€€å‡ºï¼Œä½† pidfile ä»å­˜åœ¨" | tee -a "$OPERATE_LOG"
        fi
    else
        echo "$APP_FILEç¨‹åºæœªè¿è¡Œ" | tee -a "$OPERATE_LOG"
    fi
    return 0
}

main() {
    echo "------------------------------------------------" | tee -a "$OPERATE_LOG"
    echo "Script executed at: $(date)" | tee -a "$OPERATE_LOG"
    echo "------------------------------------------------"
    echo "1. start server"
    echo "2. stop server"
    echo "3. status"
    echo "4. tail log"
    echo "5. clear log"
    echo "------------------------------------------------"
    read -p "please choose: " choice
    case $choice in
        1) start ;;
        2) stop ;;
        3) status ;;
        4) tail_log ;;
        5) clear_log ;;
        *) exit 0 ;;
    esac
}
main
```

