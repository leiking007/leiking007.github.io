---
title: "MongoDB"
date: 2024-02-02
lastmod: 2024-02-02
draft: false
tags: ['æ•°æ®åº“']
categories: ["ğŸ›¢ï¸æ•°æ®åº“"]
author: "lei"
---

# MongoDB

## ç®€ä»‹

### NoSQL

NoSQLï¼ˆNot Only SQLï¼‰ï¼Œæ„ä¸º"ä¸ä»…ä»…æ˜¯SQL"ï¼Œæ˜¯å¯¹äºä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“çš„æ•°æ®åº“ç®¡ç†ç³»ç»Ÿçš„ç»Ÿç§°

NoSQL ç”¨äºè¶…å¤§è§„æ¨¡æ•°æ®çš„å­˜å‚¨ï¼Œè¿™äº›ç±»å‹çš„æ•°æ®å­˜å‚¨ä¸éœ€è¦å›ºå®šçš„æ¨¡å¼ï¼Œæ— éœ€å¤šä½™çš„æ“ä½œå°±å¯ä»¥æ¨ªå‘æ‰©å±•

#### RDBMS ä¸ NoSQL å¯¹æ¯”

**RDBMS**

- é«˜åº¦ç»„ç»‡åŒ–ç»“æ„åŒ–æ•°æ®
- ç»“æ„åŒ–æŸ¥è¯¢è¯­è¨€ï¼ˆSQLï¼‰
- æ•°æ®ä¸å…³ç³»éƒ½å­˜å‚¨åœ¨å•ç‹¬çš„è¡¨ä¸­
- æ•°æ®æ“ä½œè¯­è¨€ï¼Œæ•°æ®å®šä¹‰è¯­è¨€
- ä¸¥æ ¼çš„ä¸€è‡´æ€§
- åŸºç¡€äº‹åŠ¡

**NoSQL**

- ä»£è¡¨ç€ä¸ä»…ä»…æ˜¯SQL
- æ²¡æœ‰å£°æ˜æ€§çš„æŸ¥è¯¢è¯­è¨€
- æ²¡æœ‰é¢„å®šä¹‰çš„æ¨¡å¼
- é”®-å€¼å¯¹å­˜å‚¨ï¼Œåˆ—å­˜å‚¨ï¼Œæ–‡æ¡£å­˜å‚¨ï¼Œå›¾å½¢æ•°æ®åº“
- æœ€ç»ˆä¸€è‡´æ€§ï¼Œè€Œé ACID å±æ€§
- éç»“æ„åŒ–å’Œä¸å¯é¢„çŸ¥çš„æ•°æ®
- CAPå®šç†ï¼ˆConsistencyï¼ˆä¸€è‡´æ€§ï¼‰ã€Availabilityï¼ˆå¯ç”¨æ€§ï¼‰ã€Partition toleranceï¼ˆåˆ†åŒºå®¹å¿æ€§ï¼‰ï¼‰
- é«˜æ€§èƒ½ï¼Œé«˜å¯ç”¨å’Œå¯ä¼¸ç¼©æ€§

#### CAPå®šç†

- **ä¸€è‡´æ€§(Consistency)** (æ‰€æœ‰èŠ‚ç‚¹åœ¨åŒä¸€æ—¶é—´å…·æœ‰ç›¸åŒçš„æ•°æ®)
- **å¯ç”¨æ€§(Availability)** (ä¿è¯æ¯ä¸ªè¯·æ±‚ä¸ç®¡æˆåŠŸæˆ–è€…å¤±è´¥éƒ½æœ‰å“åº”)

- **åˆ†åŒºå®¹å¿(Partition tolerance)** (ç³»ç»Ÿä¸­ä»»æ„ä¿¡æ¯çš„ä¸¢å¤±æˆ–å¤±è´¥ä¸ä¼šå½±å“ç³»ç»Ÿçš„ç»§ç»­è¿ä½œ)

CAP æ ¸å¿ƒç†è®ºæ˜¯ï¼šä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸å¯èƒ½åŒæ—¶å¾ˆå¥½çš„æ»¡è¶³ä¸€è‡´æ€§ã€å¯ç”¨æ€§å’Œåˆ†åŒºå®¹é”™æ€§ï¼Œæœ€å¤šåªèƒ½åŒæ—¶è¾ƒå¥½çš„æ»¡è¶³ä¸¤ä¸ª

- CA - å•ç‚¹é›†ç¾¤ï¼Œæ»¡è¶³ä¸€è‡´æ€§ï¼Œå¯ç”¨æ€§çš„ç³»ç»Ÿï¼Œé€šå¸¸åœ¨å¯æ‰©å±•æ€§ä¸Šä¸å¤ªå¼ºå¤§ã€‚
- CP - æ»¡è¶³ä¸€è‡´æ€§ï¼Œåˆ†åŒºå®¹å¿å¿…çš„ç³»ç»Ÿï¼Œé€šå¸¸æ€§èƒ½ä¸æ˜¯ç‰¹åˆ«é«˜ã€‚
- AP - æ»¡è¶³å¯ç”¨æ€§ï¼Œåˆ†åŒºå®¹å¿æ€§çš„ç³»ç»Ÿï¼Œé€šå¸¸å¯èƒ½å¯¹ä¸€è‡´æ€§è¦æ±‚ä½ä¸€äº›ã€‚

#### NoSQL ä¼˜ç‚¹å’Œç¼ºç‚¹

**ä¼˜ç‚¹**

- é«˜æ‰©å±•æ€§
- åˆ†å¸ƒå¼è®¡ç®—
- ä½æˆæœ¬
- æ¶æ„çš„çµæ´»æ€§ï¼ŒåŠç»“æ„åŒ–æ•°æ®
- æ²¡æœ‰å¤æ‚çš„å…³ç³»

**ç¼ºç‚¹**

- æ²¡æœ‰æ ‡å‡†åŒ–
- æœ‰é™çš„æŸ¥è¯¢åŠŸèƒ½
- æœ€ç»ˆä¸€è‡´æ˜¯ä¸ç›´è§‚çš„ç¨‹åº

### MongoDB æ¦‚å¿µè§£æ

MongoDB å’Œ SQLçš„æ¦‚å¿µå¯¹ç…§

| SQLæœ¯è¯­/æ¦‚å¿µ | MongoDBæœ¯è¯­/æ¦‚å¿µ | è§£é‡Šè¯´æ˜                             |
| ------------ | ---------------- | ------------------------------------ |
| database     | databases        | æ•°æ®åº“                               |
| table        | collection       | æ•°æ®åº“è¡¨/é›†åˆ                        |
| row          | document         | æ•°æ®è®°å½•è¡Œ/æ–‡æ¡£                      |
| column       | field            | æ•°æ®å­—æ®µ/åŸŸ                          |
| index        | index            | ç´¢å¼•                                 |
| table joins  |                  | è¡¨è¿æ¥/MongoDBä¸æ”¯æŒ                 |
| primary key  | primary key      | ä¸»é”®ï¼ŒMongoDBè‡ªåŠ¨å°†_idå­—æ®µè®¾ç½®ä¸ºä¸»é”® |

#### æ•°æ®åº“

ä¸€ä¸ª MongoDB å¯ä»¥å»ºç«‹å¤šä¸ªæ•°æ®åº“ã€‚

MongoDBçš„é»˜è®¤æ•°æ®åº“ä¸º"db"ï¼Œè¯¥æ•°æ®åº“å­˜å‚¨åœ¨dataç›®å½•ä¸­ã€‚

MongoDBçš„å•ä¸ªå®ä¾‹å¯ä»¥å®¹çº³å¤šä¸ªç‹¬ç«‹çš„æ•°æ®åº“ï¼Œæ¯ä¸€ä¸ªéƒ½æœ‰è‡ªå·±çš„é›†åˆå’Œæƒé™ï¼Œä¸åŒçš„æ•°æ®åº“ä¹Ÿæ”¾ç½®åœ¨ä¸åŒçš„æ–‡ä»¶ä¸­ã€‚

åˆæ³•çš„æ•°æ®åº“åï¼š

- ä¸èƒ½æ˜¯ç©ºå­—ç¬¦ä¸²ï¼ˆ"")ã€‚
- ä¸å¾—å«æœ‰' 'ï¼ˆç©ºæ ¼)ã€.ã€$ã€/ã€\å’Œ\0 (ç©ºå®‡ç¬¦)ã€‚
- åº”å…¨éƒ¨å°å†™ã€‚
- æœ€å¤š64å­—èŠ‚ã€‚

æœ‰ä¸€äº›æ•°æ®åº“åæ˜¯ä¿ç•™çš„ï¼Œå¯ä»¥ç›´æ¥è®¿é—®è¿™äº›æœ‰ç‰¹æ®Šä½œç”¨çš„æ•°æ®åº“ã€‚

- **admin**ï¼š ä»æƒé™çš„è§’åº¦æ¥çœ‹ï¼Œè¿™æ˜¯"root"æ•°æ®åº“ã€‚è¦æ˜¯å°†ä¸€ä¸ªç”¨æˆ·æ·»åŠ åˆ°è¿™ä¸ªæ•°æ®åº“ï¼Œè¿™ä¸ªç”¨æˆ·è‡ªåŠ¨ç»§æ‰¿æ‰€æœ‰æ•°æ®åº“çš„æƒé™ã€‚ä¸€äº›ç‰¹å®šçš„æœåŠ¡å™¨ç«¯å‘½ä»¤ä¹Ÿåªèƒ½ä»è¿™ä¸ªæ•°æ®åº“è¿è¡Œï¼Œæ¯”å¦‚åˆ—å‡ºæ‰€æœ‰çš„æ•°æ®åº“æˆ–è€…å…³é—­æœåŠ¡å™¨ã€‚
- **local:** è¿™ä¸ªæ•°æ®æ°¸è¿œä¸ä¼šè¢«å¤åˆ¶ï¼Œå¯ä»¥ç”¨æ¥å­˜å‚¨é™äºæœ¬åœ°å•å°æœåŠ¡å™¨çš„ä»»æ„é›†åˆ
- **config**: å½“Mongoç”¨äºåˆ†ç‰‡è®¾ç½®æ—¶ï¼Œconfigæ•°æ®åº“åœ¨å†…éƒ¨ä½¿ç”¨ï¼Œç”¨äºä¿å­˜åˆ†ç‰‡çš„ç›¸å…³ä¿¡æ¯ã€‚

#### æ–‡æ¡£

æ–‡æ¡£æ˜¯ä¸€ä¸ªé”®å€¼(key-value)å¯¹(å³BSON)ã€‚MongoDB çš„æ–‡æ¡£ä¸éœ€è¦è®¾ç½®ç›¸åŒçš„å­—æ®µï¼Œå¹¶ä¸”ç›¸åŒçš„å­—æ®µä¸éœ€è¦ç›¸åŒçš„æ•°æ®ç±»å‹ï¼Œè¿™ä¸å…³ç³»å‹æ•°æ®åº“æœ‰å¾ˆå¤§çš„åŒºåˆ«ï¼Œä¹Ÿæ˜¯ MongoDB éå¸¸çªå‡ºçš„ç‰¹ç‚¹ã€‚

#### é›†åˆ

é›†åˆå°±æ˜¯ MongoDB æ–‡æ¡£ç»„ï¼Œç±»ä¼¼äº RDBMS ï¼ˆå…³ç³»æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼šRelational Database Management System)ä¸­çš„è¡¨ã€‚

é›†åˆå­˜åœ¨äºæ•°æ®åº“ä¸­ï¼Œé›†åˆæ²¡æœ‰å›ºå®šçš„ç»“æ„ã€‚

åˆæ³•çš„é›†åˆåï¼š

- é›†åˆåä¸èƒ½æ˜¯ç©ºå­—ç¬¦ä¸²""ã€‚
- é›†åˆåä¸èƒ½å«æœ‰\0å­—ç¬¦ï¼ˆç©ºå­—ç¬¦)ï¼Œè¿™ä¸ªå­—ç¬¦è¡¨ç¤ºé›†åˆåçš„ç»“å°¾ã€‚
- é›†åˆåä¸èƒ½ä»¥"system."å¼€å¤´ï¼Œè¿™æ˜¯ä¸ºç³»ç»Ÿé›†åˆä¿ç•™çš„å‰ç¼€ã€‚
- ç”¨æˆ·åˆ›å»ºçš„é›†åˆåå­—ä¸èƒ½å«æœ‰ä¿ç•™å­—ç¬¦ã€‚æœ‰äº›é©±åŠ¨ç¨‹åºçš„ç¡®æ”¯æŒåœ¨é›†åˆåé‡Œé¢åŒ…å«ï¼Œè¿™æ˜¯å› ä¸ºæŸäº›ç³»ç»Ÿç”Ÿæˆçš„é›†åˆä¸­åŒ…å«è¯¥å­—ç¬¦ã€‚é™¤éä½ è¦è®¿é—®è¿™ç§ç³»ç»Ÿåˆ›å»ºçš„é›†åˆï¼Œå¦åˆ™åƒä¸‡ä¸è¦åœ¨åå­—é‡Œå‡ºç°$ã€‚

**capped collections**

Capped collections å°±æ˜¯å›ºå®šå¤§å°çš„ collection

Capped collections æ˜¯é«˜æ€§èƒ½è‡ªåŠ¨çš„ç»´æŠ¤å¯¹è±¡çš„æ’å…¥é¡ºåºã€‚å®ƒéå¸¸é€‚åˆç±»ä¼¼è®°å½•æ—¥å¿—çš„åŠŸèƒ½å’Œæ ‡å‡†çš„ collection ä¸åŒï¼Œä½ å¿…é¡»è¦æ˜¾å¼çš„åˆ›å»ºä¸€ä¸ªcapped collectionï¼ŒæŒ‡å®šä¸€ä¸ª collection çš„å¤§å°ï¼Œå•ä½æ˜¯å­—èŠ‚ã€‚collection çš„æ•°æ®å­˜å‚¨ç©ºé—´å€¼æå‰åˆ†é…çš„ã€‚

- åœ¨ capped collection ä¸­ï¼Œä½ èƒ½æ·»åŠ æ–°çš„å¯¹è±¡ã€‚
- èƒ½è¿›è¡Œæ›´æ–°ï¼Œç„¶è€Œï¼Œå¯¹è±¡ä¸ä¼šå¢åŠ å­˜å‚¨ç©ºé—´ã€‚å¦‚æœå¢åŠ ï¼Œæ›´æ–°å°±ä¼šå¤±è´¥ ã€‚
- ä½¿ç”¨ Capped Collection ä¸èƒ½åˆ é™¤ä¸€ä¸ªæ–‡æ¡£ï¼Œå¯ä»¥ä½¿ç”¨ drop() æ–¹æ³•åˆ é™¤ collection æ‰€æœ‰çš„è¡Œã€‚
- åˆ é™¤ä¹‹åï¼Œä½ å¿…é¡»æ˜¾å¼çš„é‡æ–°åˆ›å»ºè¿™ä¸ª collectionã€‚
- åœ¨32bitæœºå™¨ä¸­ï¼Œcapped collection æœ€å¤§å­˜å‚¨ä¸º 1e9( 1X109)ä¸ªå­—èŠ‚ã€‚

#### MongoDB æ•°æ®ç±»å‹

| æ•°æ®ç±»å‹           | æè¿°                                                         |
| :----------------- | :----------------------------------------------------------- |
| String             | å­—ç¬¦ä¸²ã€‚å­˜å‚¨æ•°æ®å¸¸ç”¨çš„æ•°æ®ç±»å‹ã€‚åœ¨ MongoDB ä¸­ï¼ŒUTF-8 ç¼–ç çš„å­—ç¬¦ä¸²æ‰æ˜¯åˆæ³•çš„ã€‚ |
| Integer            | æ•´å‹æ•°å€¼ã€‚ç”¨äºå­˜å‚¨æ•°å€¼ã€‚æ ¹æ®ä½ æ‰€é‡‡ç”¨çš„æœåŠ¡å™¨ï¼Œå¯åˆ†ä¸º 32 ä½æˆ– 64 ä½ã€‚ |
| Boolean            | å¸ƒå°”å€¼ã€‚ç”¨äºå­˜å‚¨å¸ƒå°”å€¼ï¼ˆçœŸ/å‡ï¼‰ã€‚                            |
| Double             | åŒç²¾åº¦æµ®ç‚¹å€¼ã€‚ç”¨äºå­˜å‚¨æµ®ç‚¹å€¼ã€‚                               |
| Min/Max keys       | å°†ä¸€ä¸ªå€¼ä¸ BSONï¼ˆäºŒè¿›åˆ¶çš„ JSONï¼‰å…ƒç´ çš„æœ€ä½å€¼å’Œæœ€é«˜å€¼ç›¸å¯¹æ¯”ã€‚ |
| Array              | ç”¨äºå°†æ•°ç»„æˆ–åˆ—è¡¨æˆ–å¤šä¸ªå€¼å­˜å‚¨ä¸ºä¸€ä¸ªé”®ã€‚                       |
| Timestamp          | æ—¶é—´æˆ³ã€‚è®°å½•æ–‡æ¡£ä¿®æ”¹æˆ–æ·»åŠ çš„å…·ä½“æ—¶é—´ã€‚                       |
| Object             | ç”¨äºå†…åµŒæ–‡æ¡£ã€‚                                               |
| Null               | ç”¨äºåˆ›å»ºç©ºå€¼ã€‚                                               |
| Symbol             | ç¬¦å·ã€‚è¯¥æ•°æ®ç±»å‹åŸºæœ¬ä¸Šç­‰åŒäºå­—ç¬¦ä¸²ç±»å‹ï¼Œä½†ä¸åŒçš„æ˜¯ï¼Œå®ƒä¸€èˆ¬ç”¨äºé‡‡ç”¨ç‰¹æ®Šç¬¦å·ç±»å‹çš„è¯­è¨€ã€‚ |
| Date               | æ—¥æœŸæ—¶é—´ã€‚ç”¨ UNIX æ—¶é—´æ ¼å¼æ¥å­˜å‚¨å½“å‰æ—¥æœŸæˆ–æ—¶é—´ã€‚ä½ å¯ä»¥æŒ‡å®šè‡ªå·±çš„æ—¥æœŸæ—¶é—´ï¼šåˆ›å»º Date å¯¹è±¡ï¼Œä¼ å…¥å¹´æœˆæ—¥ä¿¡æ¯ã€‚ |
| Object ID          | å¯¹è±¡ IDã€‚ç”¨äºåˆ›å»ºæ–‡æ¡£çš„ IDã€‚                                 |
| Binary Data        | äºŒè¿›åˆ¶æ•°æ®ã€‚ç”¨äºå­˜å‚¨äºŒè¿›åˆ¶æ•°æ®ã€‚                             |
| Code               | ä»£ç ç±»å‹ã€‚ç”¨äºåœ¨æ–‡æ¡£ä¸­å­˜å‚¨ JavaScript ä»£ç ã€‚                 |
| Regular expression | æ­£åˆ™è¡¨è¾¾å¼ç±»å‹ã€‚ç”¨äºå­˜å‚¨æ­£åˆ™è¡¨è¾¾å¼ã€‚                         |

#### ObjectId

ObjectId ç±»ä¼¼å”¯ä¸€ä¸»é”®ï¼Œå¯ä»¥å¾ˆå¿«çš„å»ç”Ÿæˆå’Œæ’åºï¼ŒåŒ…å« 12 bytesï¼Œå«ä¹‰æ˜¯ï¼š

- å‰ 4 ä¸ªå­—èŠ‚è¡¨ç¤ºåˆ›å»º **unix** æ—¶é—´æˆ³,æ ¼æ—å°¼æ²»æ—¶é—´ **UTC** æ—¶é—´ï¼Œæ¯”åŒ—äº¬æ—¶é—´æ™šäº† 8 ä¸ªå°æ—¶
- æ¥ä¸‹æ¥çš„ 3 ä¸ªå­—èŠ‚æ˜¯æœºå™¨æ ‡è¯†ç 
- ç´§æ¥çš„ä¸¤ä¸ªå­—èŠ‚ç”±è¿›ç¨‹ id ç»„æˆ PID
- æœ€åä¸‰ä¸ªå­—èŠ‚æ˜¯éšæœºæ•°

### MongoDB å®‰è£…ä½¿ç”¨

> debain10 ç³»ç»Ÿå®‰è£…ï¼Œå½“å‰ç‰ˆæœ¬ 7.0.5

#### å®‰è£…

1.  [Try MongoDB Community Edition | MongoDB](https://www.mongodb.com/try/download/community-kubernetes-operator)ï¼Œä¸‹è½½`Community Server Download`

2. æ‰§è¡Œå‘½ä»¤ï¼ˆå¯èƒ½éœ€è¦å°†å®‰è£…åŒ…ç§»åŠ¨åˆ° /tmp/ ç›®å½•ä¸‹ï¼Œå¯èƒ½éœ€è¦æ›´æ–°æº apt updateï¼‰

   ```bash
   apt install mongodb-org-server_7.0.5_amd64.deb
   ```

3. åˆ›å»º mongoDB æ•°æ®åº“å­˜æ”¾ç›®å½•ä»¥åŠæ—¥å¿—å­˜æ”¾ç›®å½•

   ```bash
   mkdir -p /root/mongodb/db
   mkdir -p /root/mongodb/log
   ```

4. ç›´æ¥å¯åŠ¨ mongoDBï¼Œé»˜è®¤å¯åŠ¨åªç›‘å¬äº†æœ¬åœ°ipï¼Œé»˜è®¤ç«¯å£ä¸º 27017

   ```bash
   mongod --dbpath /root/mongodb/db/ --logpath /root/mongodb/log/mongodb --fork
   ## --dbpath æŒ‡å®šæ•°æ®åº“ç›®å½•
   ## --logpath æŒ‡å®šlogæ–‡ä»¶
   ## --fork å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼å¯åŠ¨
   ```

5. ä»¥é…ç½®æ–‡ä»¶å¯åŠ¨

   åˆ›å»ºé…ç½®æ–‡ä»¶ mongoDB.conf

   ```ini
   #æŒ‡å®šæ•°æ®åº“è·¯å¾„
   dbpath=/root/mongodb/db
   #æŒ‡å®šMongoDBæ—¥å¿—æ–‡ä»¶
   logpath=/root/mongodb/log/mongodb.log
   ## ä½¿ç”¨è¿½åŠ çš„æ–¹å¼å†™æ—¥å¿—
   logappend=true
   #ç«¯å£å·
   port=27017
   #æ–¹ä¾¿å¤–ç½‘è®¿é—®
   bind_ip=0.0.0.0
   fork=true ## ä»¥å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼è¿è¡ŒMongoDBï¼Œåˆ›å»ºæœåŠ¡å™¨è¿›ç¨‹
   #auth=true #å¯ç”¨ç”¨æˆ·éªŒè¯
   #bind_ip=0.0.0.0 #ç»‘å®šæœåŠ¡IPï¼Œè‹¥ç»‘å®š127.0.0.1ï¼Œåˆ™åªèƒ½æœ¬æœºè®¿é—®ï¼Œä¸æŒ‡å®šåˆ™é»˜è®¤æœ¬åœ°æ‰€æœ‰IP
   ```

   å¯åŠ¨mongoDB

   ```bash
   mongod -f ./mongodb.conf
   ```

#### ä½¿ç”¨ shell è¿æ¥

1. å®˜ç½‘ä¸‹è½½[MongoDB Shell Download | MongoDB](https://www.mongodb.com/try/download/shell)ï¼Œå®‰è£…æ­¥éª¤å’Œ mongoDB ç±»ä¼¼

2. è¿æ¥ mongoDB ï¼Œé»˜è®¤è¿æ¥æ•°æ®åº“ä¸º test

   ```bash
   mongosh 127.0.0.1:27017
   ```
   

#### å…³é—­ mongoDB

æ–¹å¼ä¸€ï¼šmongoDB shell æ–¹å¼ï¼ˆæŒ‡å®šé€šè¿‡æœ¬åœ°shellè¿æ¥æ‰å¯ä»¥æ“ä½œï¼‰

åˆ‡æ¢åˆ° admin æ•°æ®åº“

```js
use admin   // åˆ‡æ¢ admin æ•°æ®åº“

db.shutdownServer()  // å…³é—­mongoDB
```

æ–¹å¼äºŒï¼šå‘½ä»¤å…³é—­

```bash
## é€šè¿‡ dbpath ç›®å½•å…³é—­
mongod -shutdown --dbpath /root/mongodb/db/

## é€šè¿‡é…ç½®æ–‡ä»¶å…³é—­
mongod -shutdown -f ./mongodb.conf
```

## mongoDB æ“ä½œ

mongoDB ä¸­å¯¹äºæ•°æ®åº“ã€é›†åˆä¹ƒè‡³æ–‡æ¡£ï¼Œåœ¨ä½¿ç”¨æ—¶å¦‚æœä¸å­˜åœ¨ä¼šè‡ªåŠ¨è¿›è¡Œåˆ›å»º

### æ•°æ®åº“æ“ä½œ

```js
use mydb   // åˆ‡æ¢æ•°æ®åº“

show dbs  // æŸ¥çœ‹æ•°æ®åº“åˆ—è¡¨
```

**åˆ›å»ºæ•°æ®åº“**

```js
use DATABASE_NAME
```

å¦‚æœæ•°æ®åº“ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ•°æ®åº“ç„¶ååˆ‡æ¢ï¼Œå¦åˆ™åˆ‡æ¢åˆ°æŒ‡å®šæ•°æ®åº“ã€‚

**åˆ é™¤æ•°æ®åº“**

```js
db.dropDatabase()
```

åˆ é™¤å½“å‰æ•°æ®åº“ï¼Œé»˜è®¤ä¸º testï¼Œä½ å¯ä»¥ä½¿ç”¨ db å‘½ä»¤æŸ¥çœ‹å½“å‰æ•°æ®åº“å

### é›†åˆæ“ä½œ

```js
show collections  // æŸ¥çœ‹é›†åˆåˆ—è¡¨ï¼ˆshow tablesï¼‰
```

**åˆ›å»ºé›†åˆ**

```js
db.createCollection(name, options)
/*
å‚æ•°è¯´æ˜	
name: è¦åˆ›å»ºçš„é›†åˆåç§°
options: å¯é€‰å‚æ•°, æŒ‡å®šæœ‰å…³å†…å­˜å¤§å°åŠç´¢å¼•çš„é€‰é¡¹
		cappedï¼šå¯é€‰ï¼‰å¦‚æœä¸º trueï¼Œåˆ™åˆ›å»ºå›ºå®šé›†åˆï¼ˆå¿…é¡»æŒ‡å®š size å‚æ•°ï¼‰
		sizeï¼šï¼ˆå¯é€‰ï¼‰ä¸ºå›ºå®šé›†åˆæŒ‡å®šä¸€ä¸ªæœ€å¤§å€¼ï¼Œå³å­—èŠ‚æ•°
		maxï¼šï¼ˆå¯é€‰ï¼‰æŒ‡å®šå›ºå®šé›†åˆä¸­åŒ…å«æ–‡æ¡£çš„æœ€å¤§æ•°é‡
*/
```

åœ¨æ’å…¥æ–‡æ¡£æ—¶ï¼ŒMongoDB é¦–å…ˆæ£€æŸ¥å›ºå®šé›†åˆçš„ size å­—æ®µï¼Œç„¶åæ£€æŸ¥ max å­—æ®µ

**åˆ é™¤é›†åˆ**

```js
db.collection.drop()
// å¦‚æœæˆåŠŸåˆ é™¤é€‰å®šé›†åˆï¼Œåˆ™ drop() æ–¹æ³•è¿”å› trueï¼Œå¦åˆ™è¿”å› false
```

### æ–‡æ¡£çš„å¢åˆ æ”¹

**æ’å…¥æ–‡æ¡£**

```js
// è‹¥æ’å…¥çš„æ•°æ®ä¸»é”®å·²ç»å­˜åœ¨ï¼Œåˆ™ä¼šæŠ› org.springframework.dao.DuplicateKeyException å¼‚å¸¸ï¼Œæç¤ºä¸»é”®é‡å¤ï¼Œä¸ä¿å­˜å½“å‰æ•°æ®
db.COLLECTION_NAME.insert(document)

// ç”¨äºå‘é›†åˆæ’å…¥ä¸€ä¸ªæ–°æ–‡æ¡£
db.collection.insertOne(
   <document>,
   {
      writeConcern: <document>
   }
)

// ç”¨äºå‘é›†åˆæ’å…¥ä¸€ä¸ªå¤šä¸ªæ–‡æ¡£
db.collection.insertMany(
   [ <document 1> , <document 2>, ... ],
   {
      writeConcern: <document>,
      ordered: <boolean>
   }
)
```

å‚æ•°è¯´æ˜

- documentï¼šè¦å†™å…¥çš„æ–‡æ¡£ã€‚
- writeConcernï¼šå†™å…¥ç­–ç•¥ï¼Œé»˜è®¤ä¸º 1ï¼Œå³è¦æ±‚ç¡®è®¤å†™æ“ä½œï¼Œ0 æ˜¯ä¸è¦æ±‚ã€‚
- orderedï¼šæŒ‡å®šæ˜¯å¦æŒ‰é¡ºåºå†™å…¥ï¼Œé»˜è®¤ trueï¼ŒæŒ‰é¡ºåºå†™å…¥ã€‚

**æ›´æ–°æ–‡æ¡£**

```js
db.collection.update(
   <query>,
   <update>,
   {
     upsert: <boolean>,
     multi: <boolean>,
     writeConcern: <document>
   }
)
```

å‚æ•°è¯´æ˜ï¼š

- query : updateçš„æŸ¥è¯¢æ¡ä»¶ï¼Œç±»ä¼¼sql updateæŸ¥è¯¢å†…whereåé¢çš„ã€‚
- update : updateçš„å¯¹è±¡å’Œä¸€äº›æ›´æ–°çš„æ“ä½œç¬¦ï¼ˆå¦‚$,$inc...ï¼‰ç­‰ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºsql updateæŸ¥è¯¢å†…setåé¢çš„
- upsert : å¯é€‰ï¼Œè¿™ä¸ªå‚æ•°çš„æ„æ€æ˜¯ï¼Œå¦‚æœä¸å­˜åœ¨updateçš„è®°å½•ï¼Œæ˜¯å¦æ’å…¥objNew,trueä¸ºæ’å…¥ï¼Œé»˜è®¤æ˜¯falseï¼Œä¸æ’å…¥ã€‚
- multi : å¯é€‰ï¼Œmongodb é»˜è®¤æ˜¯false,åªæ›´æ–°æ‰¾åˆ°çš„ç¬¬ä¸€æ¡è®°å½•ï¼Œå¦‚æœè¿™ä¸ªå‚æ•°ä¸ºtrue,å°±æŠŠæŒ‰æ¡ä»¶æŸ¥å‡ºæ¥å¤šæ¡è®°å½•å…¨éƒ¨æ›´æ–°ã€‚
- writeConcern :å¯é€‰ï¼ŒæŠ›å‡ºå¼‚å¸¸çš„çº§åˆ«ã€‚

**åˆ é™¤æ–‡æ¡£**

```js
db.collection.remove(
   <query>,
   {
     justOne: <boolean>,
     writeConcern: <document>
   }
)
```

å‚æ•°è¯´æ˜ï¼š

- query*:ï¼ˆå¯é€‰ï¼‰åˆ é™¤çš„æ–‡æ¡£çš„æ¡ä»¶ã€‚
- justOne : ï¼ˆå¯é€‰ï¼‰å¦‚æœè®¾ä¸º true æˆ– 1ï¼Œåˆ™åªåˆ é™¤ä¸€ä¸ªæ–‡æ¡£ï¼Œå¦‚æœä¸è®¾ç½®è¯¥å‚æ•°ï¼Œæˆ–ä½¿ç”¨é»˜è®¤å€¼ falseï¼Œåˆ™åˆ é™¤æ‰€æœ‰åŒ¹é…æ¡ä»¶çš„æ–‡æ¡£ã€‚
- writeConcern :ï¼ˆå¯é€‰ï¼‰æŠ›å‡ºå¼‚å¸¸çš„çº§åˆ«ã€‚

### æŸ¥è¯¢æ–‡æ¡£

#### æ•°æ®å‡†å¤‡

ç¤ºä¾‹æ•°æ®ï¼šæ’å…¥ä¸¤æ¡æµ‹è¯•æ•°æ®

```js
db.col.insertMany([{
        "name" : "å¼ ä¸‰",
        "tags" : [
                "java",
                "vue",
        ],
        "age" : 43,
		"address": "12sad"
},{
        "name" : "æå››",
        "tags" : [
                "python",
                "react"
        ],
        "age" : 65,
		"address": "12sad"
}])
```

#### æŸ¥è¯¢åŸºç¡€

mongoDB æŸ¥è¯¢æ–‡æ¡£ä½¿ç”¨ find() æ–¹æ³•ï¼Œfind() æ–¹æ³•ä»¥éç»“æ„åŒ–çš„æ–¹å¼æ¥æ˜¾ç¤ºæ‰€æœ‰æ–‡æ¡£ã€‚

**MongoDB å’Œ SQL Where è¯­å¥æ¯”è¾ƒ**

| æ“ä½œ       | æ ¼å¼                     | èŒƒä¾‹                                      | SQLä¸­çš„ç±»ä¼¼è¯­å¥      |
| :--------- | :----------------------- | :---------------------------------------- | :------------------- |
| ç­‰äº       | `{<key>:<value>`}        | `db.col.find({"name":"å¼ ä¸‰"}).pretty()`   | `where name= 'å¼ ä¸‰'` |
| å°äº       | `{<key>:{$lt:<value>}}`  | `db.col.find({"age":{$lt:50}}).pretty()`  | `where age< 50`      |
| å°äºæˆ–ç­‰äº | `{<key>:{$lte:<value>}}` | `db.col.find({"age":{$lte:50}}).pretty()` | `where age <= 50`    |
| å¤§äº       | `{<key>:{$gt:<value>}}`  | `db.col.find({"age":{$gt:50}}).pretty()`  | `where age > 50`     |
| å¤§äºæˆ–ç­‰äº | `{<key>:{$gte:<value>}}` | `db.col.find({"age":{$gte:50}}).pretty()` | `where age >= 50`    |
| ä¸ç­‰äº     | `{<key>:{$ne:<value>}}`  | `db.col.find({"age":{$ne:50}}).pretty()`  | `where age != 50`    |

> MongoDB çš„ find() æ–¹æ³•å¯ä»¥ä¼ å…¥å¤šä¸ªé”®(key)ï¼Œæ¯ä¸ªé”®(key)ä»¥é€—å·éš”å¼€ï¼Œç›¸å½“äº SQL çš„ AND æ¡ä»¶

```js
db.col.find({key1:value1, key2:value2}).pretty()

// æŸ¥è¯¢ address='12sad' and age < 50
db.col.find({address:'12sad',age:{$lt:50}})
```

>MongoDB OR æ¡ä»¶è¯­å¥ä½¿ç”¨äº†å…³é”®å­— **$or**

```js
db.col.find(
   {
      $or: [
         {key1: value1}, {key2:value2}
      ]
   }
).pretty()

// æŸ¥è¯¢ age>50 or name ='å¼ ä¸‰'
db.col.find({
	$or:[
    	{age:{$gt:50}},{name:'å¼ ä¸‰'}
    ]
})
```

> $type æ“ä½œç¬¦ä½¿ç”¨

```js
// æŸ¥è¯¢nameå­—æ®µä¸ºstringç±»å‹æ•°æ®
db.col.find({
    name:{$type:'string'}
})
```

#### limitå’Œskip

```js
// è¯»å–æŒ‡å®šæ•°é‡çš„æ•°æ®
db.COLLECTION_NAME.find().limit(NUMBER)
 
// è·³è¿‡æŒ‡å®šæ•°é‡çš„æ•°æ®
db.COLLECTION_NAME.find().skip(NUMBER)

// ç»„åˆä½¿ç”¨ï¼ˆåˆ†é¡µï¼‰
db.COLLECTION_NAME.find().limit(pageSize).skip((pageSize-1)*pageNumber)
```

#### æ’åº

åœ¨ MongoDB ä¸­ä½¿ç”¨ sort() æ–¹æ³•å¯¹æ•°æ®è¿›è¡Œæ’åºï¼Œsort() æ–¹æ³•å¯ä»¥é€šè¿‡å‚æ•°æŒ‡å®šæ’åºçš„å­—æ®µï¼Œå¹¶ä½¿ç”¨ 1 å’Œ -1 æ¥æŒ‡å®šæ’åºçš„æ–¹å¼ï¼Œ`å…¶ä¸­ 1 ä¸ºå‡åºæ’åˆ—ï¼Œè€Œ -1 æ˜¯ç”¨äºé™åºæ’åˆ—`ã€‚

```js
db.COLLECTION_NAME.find().sort({KEY:1})
```

### ç´¢å¼•

ç´¢å¼•é€šå¸¸èƒ½å¤Ÿæå¤§çš„æé«˜æŸ¥è¯¢çš„æ•ˆç‡ï¼Œå¦‚æœæ²¡æœ‰ç´¢å¼•ï¼ŒMongoDBåœ¨è¯»å–æ•°æ®æ—¶å¿…é¡»æ‰«æé›†åˆä¸­çš„æ¯ä¸ªæ–‡ä»¶å¹¶é€‰å–é‚£äº›ç¬¦åˆæŸ¥è¯¢æ¡ä»¶çš„è®°å½•ï¼Œæ•ˆç‡ååˆ†ä½ä¸‹ã€‚

ç´¢å¼•æ˜¯ç‰¹æ®Šçš„æ•°æ®ç»“æ„ï¼Œç´¢å¼•å­˜å‚¨åœ¨ä¸€ä¸ªæ˜“äºéå†è¯»å–çš„æ•°æ®é›†åˆä¸­ï¼Œç´¢å¼•æ˜¯å¯¹æ•°æ®åº“è¡¨ä¸­ä¸€åˆ—æˆ–å¤šåˆ—çš„å€¼è¿›è¡Œæ’åºçš„ä¸€ç§ç»“æ„

```js
// è¯­æ³•ä¸­ Key å€¼ä¸ºä½ è¦åˆ›å»ºçš„ç´¢å¼•å­—æ®µï¼Œ1 ä¸ºæŒ‡å®šæŒ‰å‡åºåˆ›å»ºç´¢å¼•ï¼Œå¦‚æœä½ æƒ³æŒ‰é™åºæ¥åˆ›å»ºç´¢å¼•æŒ‡å®šä¸º -1 å³å¯
db.collection.createIndex(keys, options)

// ä¸º name å­—æ®µåˆ›å»ºç´¢å¼•
db.col.createIndex({"name":1})

// ä¸º name å­—æ®µå’Œ age å­—æ®µåˆ›å»ºâ€œå¤åˆç´¢å¼•â€
db.col.createIndex({"name":1,"age":-1})
```

optionså‚æ•°è¯´æ˜

| Parameter          | Type          | Description                                                  |
| :----------------- | :------------ | :----------------------------------------------------------- |
| background         | Boolean       | å»ºç´¢å¼•è¿‡ç¨‹ä¼šé˜»å¡å…¶å®ƒæ•°æ®åº“æ“ä½œï¼Œbackgroundå¯æŒ‡å®šä»¥åå°æ–¹å¼åˆ›å»ºç´¢å¼•ï¼Œå³å¢åŠ  "background" å¯é€‰å‚æ•°ã€‚ "background" é»˜è®¤å€¼ä¸º**false**ã€‚ |
| unique             | Boolean       | å»ºç«‹çš„ç´¢å¼•æ˜¯å¦å”¯ä¸€ã€‚æŒ‡å®šä¸ºtrueåˆ›å»ºå”¯ä¸€ç´¢å¼•ã€‚é»˜è®¤å€¼ä¸º**false**. |
| name               | string        | ç´¢å¼•çš„åç§°ã€‚å¦‚æœæœªæŒ‡å®šï¼ŒMongoDBçš„é€šè¿‡è¿æ¥ç´¢å¼•çš„å­—æ®µåå’Œæ’åºé¡ºåºç”Ÿæˆä¸€ä¸ªç´¢å¼•åç§°ã€‚ |
| dropDups           | Boolean       | **3.0+ç‰ˆæœ¬å·²åºŸå¼ƒã€‚**åœ¨å»ºç«‹å”¯ä¸€ç´¢å¼•æ—¶æ˜¯å¦åˆ é™¤é‡å¤è®°å½•,æŒ‡å®š true åˆ›å»ºå”¯ä¸€ç´¢å¼•ã€‚é»˜è®¤å€¼ä¸º **false**. |
| sparse             | Boolean       | å¯¹æ–‡æ¡£ä¸­ä¸å­˜åœ¨çš„å­—æ®µæ•°æ®ä¸å¯ç”¨ç´¢å¼•ï¼›è¿™ä¸ªå‚æ•°éœ€è¦ç‰¹åˆ«æ³¨æ„ï¼Œå¦‚æœè®¾ç½®ä¸ºtrueçš„è¯ï¼Œåœ¨ç´¢å¼•å­—æ®µä¸­ä¸ä¼šæŸ¥è¯¢å‡ºä¸åŒ…å«å¯¹åº”å­—æ®µçš„æ–‡æ¡£.ã€‚é»˜è®¤å€¼ä¸º **false**. |
| expireAfterSeconds | integer       | æŒ‡å®šä¸€ä¸ªä»¥ç§’ä¸ºå•ä½çš„æ•°å€¼ï¼Œå®Œæˆ TTLè®¾å®šï¼Œè®¾å®šé›†åˆçš„ç”Ÿå­˜æ—¶é—´ã€‚ |
| v                  | index version | ç´¢å¼•çš„ç‰ˆæœ¬å·ã€‚é»˜è®¤çš„ç´¢å¼•ç‰ˆæœ¬å–å†³äºmongodåˆ›å»ºç´¢å¼•æ—¶è¿è¡Œçš„ç‰ˆæœ¬ã€‚ |
| weights            | document      | ç´¢å¼•æƒé‡å€¼ï¼Œæ•°å€¼åœ¨ 1 åˆ° 99,999 ä¹‹é—´ï¼Œè¡¨ç¤ºè¯¥ç´¢å¼•ç›¸å¯¹äºå…¶ä»–ç´¢å¼•å­—æ®µçš„å¾—åˆ†æƒé‡ã€‚ |
| default_language   | string        | å¯¹äºæ–‡æœ¬ç´¢å¼•ï¼Œè¯¥å‚æ•°å†³å®šäº†åœç”¨è¯åŠè¯å¹²å’Œè¯å™¨çš„è§„åˆ™çš„åˆ—è¡¨ã€‚ é»˜è®¤ä¸ºè‹±è¯­ |
| language_override  | string        | å¯¹äºæ–‡æœ¬ç´¢å¼•ï¼Œè¯¥å‚æ•°æŒ‡å®šäº†åŒ…å«åœ¨æ–‡æ¡£ä¸­çš„å­—æ®µåï¼Œè¯­è¨€è¦†ç›–é»˜è®¤çš„languageï¼Œé»˜è®¤å€¼ä¸º language. |

### èšåˆ

ç¤ºä¾‹æ•°æ®Â·

```js
db.student.insertMany([{
    "id": "1",
    "name": "å°æ˜",
    "age": NumberInt(12),
    "sex": "ç”·",
    "course": ["æ•°å­¦", "è¯­æ–‡", "è‹±è¯­"]
}, {
    "id": "2",
    "name": "å°ç« ",
    "age": NumberInt(13),
    "sex": "ç”·",
    "course": ["æ•°å­¦", "è¯­æ–‡"]
}, {
    "id": "3",
    "name": "å°ä¹",
    "age": NumberInt(12),
    "sex": "å¥³",
    "course": ["æ•°å­¦"]
}]);
```

>MongoDB çš„èšåˆæ¡†æ¶å°±æ˜¯å°†æ–‡æ¡£è¾“å…¥å¤„ç†ç®¡é“ï¼Œåœ¨ç®¡é“å†…å®Œæˆå¯¹æ–‡æ¡£çš„æ“ä½œï¼Œæœ€ç»ˆå°†æ–‡æ¡£è½¬æ¢ä¸ºèšåˆç»“æœï¼ŒMongoDBçš„èšåˆç®¡é“å°†MongoDBæ–‡æ¡£åœ¨ä¸€ä¸ªç®¡é“å¤„ç†å®Œæ¯•åå°†ç»“æœä¼ é€’ç»™ä¸‹ä¸€ä¸ªç®¡é“å¤„ç†ï¼Œç®¡é“æ“ä½œæ˜¯å¯ä»¥é‡å¤çš„ã€‚

MongoDB ä¸­èšåˆ(aggregate)ä¸»è¦ç”¨äºå¤„ç†æ•°æ®(è¯¸å¦‚ç»Ÿè®¡å¹³å‡å€¼ï¼Œæ±‚å’Œç­‰)ï¼Œå¹¶è¿”å›è®¡ç®—åçš„æ•°æ®ç»“æœ

```js
// å¯ä»¥ç”¨å¤šä¸ªæ„ä»¶åˆ›å»ºä¸€ä¸ªç®¡é“ï¼Œå¯¹äºä¸€è¿ä¸²çš„æ–‡æ¡£è¿›è¡Œå¤„ç†ã€‚è¿™äº›æ„ä»¶åŒ…æ‹¬ï¼šç­›é€‰æ“ä½œçš„matchã€æ˜ å°„æ“ä½œçš„projectã€åˆ†ç»„æ“ä½œçš„groupã€æ’åºæ“ä½œçš„sortã€é™åˆ¶æ“ä½œçš„limitã€å’Œè·³è¿‡æ“ä½œçš„skip
db.COLLECTION_NAME.aggregate(AGGREGATE_OPERATION)
```

èšåˆä¸­å¸¸ç”¨çš„æ“ä½œ

- $projectï¼šä¿®æ”¹è¾“å…¥æ–‡æ¡£çš„ç»“æ„ã€‚å¯ä»¥ç”¨æ¥é‡å‘½åã€å¢åŠ æˆ–åˆ é™¤åŸŸï¼Œä¹Ÿå¯ä»¥ç”¨äºåˆ›å»ºè®¡ç®—ç»“æœä»¥åŠåµŒå¥—æ–‡æ¡£ã€‚
- $matchï¼šç”¨äºè¿‡æ»¤æ•°æ®ï¼Œåªè¾“å‡ºç¬¦åˆæ¡ä»¶çš„æ–‡æ¡£ã€‚$matchä½¿ç”¨MongoDBçš„æ ‡å‡†æŸ¥è¯¢æ“ä½œã€‚
- $limitï¼šç”¨æ¥é™åˆ¶MongoDBèšåˆç®¡é“è¿”å›çš„æ–‡æ¡£æ•°ã€‚
- $skipï¼šåœ¨èšåˆç®¡é“ä¸­è·³è¿‡æŒ‡å®šæ•°é‡çš„æ–‡æ¡£ï¼Œå¹¶è¿”å›ä½™ä¸‹çš„æ–‡æ¡£ã€‚
- $unwindï¼šå°†æ–‡æ¡£ä¸­çš„æŸä¸€ä¸ªæ•°ç»„ç±»å‹å­—æ®µæ‹†åˆ†æˆå¤šæ¡ï¼Œæ¯æ¡åŒ…å«æ•°ç»„ä¸­çš„ä¸€ä¸ªå€¼ã€‚
- $groupï¼šå°†é›†åˆä¸­çš„æ–‡æ¡£åˆ†ç»„ï¼Œå¯ç”¨äºç»Ÿè®¡ç»“æœã€‚
- $sortï¼šå°†è¾“å…¥æ–‡æ¡£æ’åºåè¾“å‡ºã€‚
- $geoNearï¼šè¾“å‡ºæ¥è¿‘æŸä¸€åœ°ç†ä½ç½®çš„æœ‰åºæ–‡æ¡£ã€‚

ä¸€äº›èšåˆè¡¨è¾¾å¼

| è¡¨è¾¾å¼    | æè¿°                                                         | å®ä¾‹                                                         |
| :-------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| $sum      | è®¡ç®—æ€»å’Œã€‚                                                   | db.mycol.aggregate([{$group : {_id : "$by_user", num_tutorial : {$sum : "$likes"}}}]) |
| $avg      | è®¡ç®—å¹³å‡å€¼                                                   | db.mycol.aggregate([{$group : {_id : "$by_user", num_tutorial : {$avg : "$likes"}}}]) |
| $min      | è·å–é›†åˆä¸­æ‰€æœ‰æ–‡æ¡£å¯¹åº”å€¼å¾—æœ€å°å€¼ã€‚                           | db.mycol.aggregate([{$group : {_id : "$by_user", num_tutorial : {$min : "$likes"}}}]) |
| $max      | è·å–é›†åˆä¸­æ‰€æœ‰æ–‡æ¡£å¯¹åº”å€¼å¾—æœ€å¤§å€¼ã€‚                           | db.mycol.aggregate([{$group : {_id : "$by_user", num_tutorial : {$max : "$likes"}}}]) |
| $push     | å°†å€¼åŠ å…¥ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œä¸ä¼šåˆ¤æ–­æ˜¯å¦æœ‰é‡å¤çš„å€¼ã€‚                 | db.mycol.aggregate([{$group : {_id : "$by_user", url : {$push: "$url"}}}]) |
| $addToSet | å°†å€¼åŠ å…¥ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œä¼šåˆ¤æ–­æ˜¯å¦æœ‰é‡å¤çš„å€¼ï¼Œè‹¥ç›¸åŒçš„å€¼åœ¨æ•°ç»„ä¸­å·²ç»å­˜åœ¨äº†ï¼Œåˆ™ä¸åŠ å…¥ã€‚ | db.mycol.aggregate([{$group : {_id : "$by_user", url : {$addToSet : "$url"}}}]) |
| $first    | æ ¹æ®èµ„æºæ–‡æ¡£çš„æ’åºè·å–ç¬¬ä¸€ä¸ªæ–‡æ¡£æ•°æ®ã€‚                       | db.mycol.aggregate([{$group : {_id : "$by_user", first_url : {$first : "$url"}}}]) |
| $last     | æ ¹æ®èµ„æºæ–‡æ¡£çš„æ’åºè·å–æœ€åä¸€ä¸ªæ–‡æ¡£æ•°æ®                       | db.mycol.aggregate([{$group : {_id : "$by_user", last_url : {$last : "$url"}}}]) |

```js
// é¦–å…ˆè¿‡æ»¤å‡º age = 12 çš„æ•°æ®ï¼Œç„¶åç»Ÿè®¡æ€»å…±çš„æ•°æ®ä¸ªæ•°
db.student.aggregate([
	{
		$match:{
			age:NumberInt(12)
		}
	},
	{
		$count:"name"
	}
])

// æ ¹æ® sex åˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡åˆ†ç»„åå„æœ‰å¤šå°‘äºº
db.student.aggregate([ 
    { $group: { _id: "$sex", "num": { $sum:1 } } }
] )

// æŸ¥è¯¢æ•°æ®æ€»æ¡æ•°
db.student.aggregate([ { $group: { _id: null, "num": { $sum: 1 } } }] )
```

## mongoDB é›†ç¾¤

### å‰¯æœ¬é›†(replSet)

#### ç®€ä»‹

MongoDBå‰¯æœ¬é›†æ˜¯ç”±ä¸€ä¸ªä¸»èŠ‚ç‚¹å’Œå¤šä¸ªå‰¯æœ¬èŠ‚ç‚¹ç»„æˆã€‚ä¸»èŠ‚ç‚¹å°†æ•°æ®çš„æ”¹å˜æ¨é€åˆ°å‰¯æœ¬èŠ‚ç‚¹ä¸Šï¼Œåœ¨ä¸€å®šçš„å»¶è¿Ÿä¹‹åï¼Œæ¯ä¸ªMongoDBå®ä¾‹ç»´æŠ¤ç›¸åŒçš„æ•°æ®ã€‚é€šè¿‡ç»´æŠ¤å†—ä½™çš„æ•°æ®å‰¯æœ¬ï¼Œèƒ½å¤Ÿå®ç°æ•°æ®çš„å¤‡ä»½ï¼Œè¯»å†™åˆ†ç¦»å’Œè‡ªåŠ¨æ•…éšœè½¬ç§»ã€‚

ä¸»èŠ‚ç‚¹è®°å½•åœ¨å…¶ä¸Šçš„æ‰€æœ‰æ“ä½œoplogï¼Œä»èŠ‚ç‚¹å®šæœŸè½®è¯¢ä¸»èŠ‚ç‚¹è·å–è¿™äº›æ“ä½œï¼Œç„¶åå¯¹è‡ªå·±çš„æ•°æ®å‰¯æœ¬æ‰§è¡Œè¿™äº›æ“ä½œï¼Œä»è€Œä¿è¯ä»èŠ‚ç‚¹çš„æ•°æ®ä¸ä¸»èŠ‚ç‚¹ä¸€è‡´ã€‚

**ä½¿ç”¨åœºæ™¯**

- æ•°æ®å†—ä½™ï¼Œç”¨åšæ•…éšœæ¢å¤ä½¿ç”¨ï¼Œå½“å‘ç”Ÿç¡¬ä»¶æ•…éšœæˆ–è€…å…¶å®ƒåŸå› é€ æˆçš„å®•æœºæ—¶ï¼Œå¯ä»¥ä½¿ç”¨å‰¯æœ¬è¿›è¡Œæ¢å¤ã€‚
- è¯»å†™åˆ†ç¦»ï¼Œè¯»è¯·æ±‚ä¼šåˆ†æµåˆ°æ‰€æœ‰å‰¯æœ¬ä¸Šï¼Œå‡è½»ä¸»èŠ‚ç‚¹çš„è¯»å‹åŠ›ã€‚

MongoDBå‰¯æœ¬é›†æ˜¯ä¸»ä»å¤åˆ¶çš„é«˜çº§å½¢å¼ã€‚ä¸»ä»å¤åˆ¶ä»…ä»…å®ç°äº†æ•°æ®å¤‡ä»½å’Œè¯»å†™åˆ†ç¦»ï¼Œä½†æ˜¯ä¸»èŠ‚ç‚¹ä¸€æ—¦å®•æœºï¼Œéœ€è¦æ‰‹åŠ¨å¯åŠ¨ä»èŠ‚ç‚¹è¿›è¡Œæ•…éšœè½¬ç§»ï¼›MongoDBå‰¯æœ¬é›†åœ¨ä¸»ä»å¤åˆ¶åŸºç¡€ä¸Šå®ç°äº†æ•…éšœè½¬ç§»çš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯å½“ä¸»èŠ‚ç‚¹å®•æœºæ—¶ï¼ŒæŸä¸€å°å‰¯æœ¬èŠ‚ç‚¹ä¼šè‡ªåŠ¨æå‡ä¸ºæ–°ä¸»èŠ‚ç‚¹ã€‚

**å‰¯æœ¬é›†æˆå‘˜**

- ä¸»èŠ‚ç‚¹ï¼šå’Œå…¶ä»–æ•°æ®åº“ä¸Šçš„ä¸»èŠ‚ç‚¹ä¸€æ ·ï¼Œå¯ä»¥æä¾›è¯»å†™æœåŠ¡
- å‰¯æœ¬èŠ‚ç‚¹ï¼šä¹ŸåŸºæœ¬ä¸Šå’Œå…¶ä»–ç±»å‹æ•°æ®åº“çš„ä»èŠ‚ç‚¹ä¸€æ ·ï¼Œå¯ä»¥å®ç°å¤‡ä»½å’Œè¯»å†™åˆ†ç¦»çš„ä½œç”¨
- ä»²è£èŠ‚ç‚¹ï¼šæ²¡æœ‰æ•°æ®å‰¯æœ¬ï¼Œä¸ä¼šæˆä¸ºä¸»èŠ‚ç‚¹ï¼Œä¸»è¦ç”¨æ¥é€‰ä¸¾æŠ•ç¥¨ã€‚å½“å‰¯æœ¬é›†çš„èŠ‚ç‚¹æ•°æ®ä¸ºå¶æ•°æ—¶ï¼Œéœ€è¦æ·»åŠ ä¸€ä¸ªä»²è£èŠ‚ç‚¹ã€‚ä»²è£èŠ‚ç‚¹å› ä¸ºæ²¡æœ‰æ•°æ®ï¼Œåªå‚ä¸æŠ•ç¥¨ï¼Œæ‰€ä»¥ä»²è£èŠ‚ç‚¹éœ€è¦çš„èµ„æºå¾ˆå°ï¼Œä½†æ˜¯ä¸å»ºè®®å°†ä»²è£èŠ‚ç‚¹éƒ¨ç½²åœ¨å‰¯æœ¬é›†çš„å…¶ä»–èŠ‚ç‚¹ä¸Šã€‚

**å‰¯æœ¬é›†ç‰¹å¾**

- N ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤
- ä»»ä½•èŠ‚ç‚¹å¯ä½œä¸ºä¸»èŠ‚ç‚¹
- æ‰€æœ‰å†™å…¥æ“ä½œéƒ½åœ¨ä¸»èŠ‚ç‚¹ä¸Š
- è‡ªåŠ¨æ•…éšœè½¬ç§»
- è‡ªåŠ¨æ¢å¤

#### æ­å»º

ä¸ºäº†ç®€ä¾¿ï¼Œå…¨é‡‡ç”¨å‘½ä»¤è¡Œå¯åŠ¨ mongoDB

```bash
## åˆ›å»ºä¸‰ä¸ªç›®å½•ç”¨äºå­˜æ”¾ mongoDB æ•°æ®åº“æ–‡ä»¶
mkdir -p rs1/db
mkdir -p rs2/db
mkdir -p rs3/db

## é€šè¿‡ä¸åŒç«¯å£å¯åŠ¨ä¸‰ä¸ª mongoDB å®ä¾‹
#		bind_ip å…è®¸æ‰€æœ‰åœ°å€è®¿é—®
#		replSet æŒ‡å®šå‰¯æœ¬é›†åç§°
mongod --bind_ip "0.0.0.0" --port "30001" --dbpath "/root/mongodb/replSet/rs1" -logpath "/root/mongodb/replSet/rs1.log" --replSet "replSet" --fork
mongod --bind_ip "0.0.0.0" --port "30002" --dbpath "/root/mongodb/replSet/rs2" -logpath "/root/mongodb/replSet/rs2.log" --replSet "replSet" --fork
mongod --bind_ip "0.0.0.0" --port "30003" --dbpath "/root/mongodb/replSet/rs3" -logpath "/root/mongodb/replSet/rs3.log" --replSet "replSet" --fork
```

ç™»å½•ä»»æ„èŠ‚ç‚¹è¿›è¡Œå‰¯æœ¬é›†åˆå§‹åŒ–é…ç½®ï¼Œåˆå§‹åŒ–é…ç½®åªéœ€è¦æ‰§è¡Œä¸€æ¬¡

```js
// åˆ‡æ¢åˆ° admin æ•°æ®åº“
use admin
// é€šè¿‡ initiate æ–¹æ³•åˆå§‹åŒ–å‰¯æœ¬é›†ï¼Œå¹¶æ·»åŠ èŠ‚ç‚¹
// 		arbiterOnly æ˜¯å¦ä¸ºä»²è£èŠ‚ç‚¹ï¼Œä¸å‚ä¸æ•°æ®å¤åˆ¶ï¼Œä»…é€‰ä¸¾ master èŠ‚ç‚¹
rs.initiate({
	"_id":"replSet",
	"members":[
		{"_id" : 0, "host" : "127.0.0.1:30001"},
		{"_id" : 1, "host" : "127.0.0.1:30002"},
		{"_id" : 2, "host" : "127.0.0.1:30003","arbiterOnly":true}
	]
})
```

**å…¶ä»–æ“ä½œ**

```js
// å‰¯æœ¬é›†çŠ¶æ€
rs.status()

// æŸ¥çœ‹ master èŠ‚ç‚¹ç›¸å…³ä¿¡æ¯
db.isMaster()

// æ·»åŠ èŠ‚ç‚¹
rs.add("mongod1.net:27017")

// æ·»åŠ å†²è£èŠ‚ç‚¹
rs.addArb(â€œip:portâ€)

// ç§»é™¤èŠ‚ç‚¹
rs.remove("ip:port")
```

**å‰¯æœ¬é›†ç›¸å…³å‘½ä»¤æ±‡æ€»**

```js
rs.initiate() 	// ä½¿ç”¨é»˜è®¤é…ç½®åˆå§‹åŒ–å‰¯æœ¬é›†
rs.initiate(cfg) 	// ä½¿ç”¨é…ç½®æ–‡ä»¶cfgåˆå§‹åŒ–å‰¯æœ¬é›†
rs.reconfig(cfg) 	// ä¿®æ”¹å‰¯æœ¬é›†é…ç½®ä¿¡æ¯
rs.status() 	// æŸ¥çœ‹å‰¯æœ¬é›†çŠ¶æ€
rs.conf() 	// æŸ¥çœ‹å‰¯æœ¬é›†é…ç½®
rs.add(hostportstr) 	// æ·»åŠ æ–°çš„èŠ‚ç‚¹ 
rs.addArb(hostportstr) 	// æ·»åŠ ä»²è£èŠ‚ç‚¹
rs.remove(hostportstr) 	// åˆ é™¤èŠ‚ç‚¹
rs.slaveOk() 	// å…è®¸å‰¯æœ¬èŠ‚ç‚¹åªè¯»ï¼Œé»˜è®¤å‰¯æœ¬èŠ‚ç‚¹ä¸å…è®¸è¯»å†™
rs.isMaster() 	// æŸ¥çœ‹å“ªä¸ªèŠ‚ç‚¹ä¸ºä¸»èŠ‚ç‚¹
rs.printReplicationInfo() 	// æŸ¥çœ‹oplogå¤§å°ä»¥åŠoplogå¯ç”¨æ—¶é—´ï¼Œå¯ä»¥åˆ¤æ–­ç³»ç»Ÿç¹å¿™ç¨‹åº¦
rs.printSlaveReplicationInfo() 	// æŸ¥çœ‹å¤åˆ¶é›†æˆå‘˜ä»¥åŠå»¶è¿Ÿ
rs.stepDown([stepdownSecs, catchUpSecs]) 	// æ‰‹åŠ¨ä¸»ä»åˆ‡æ¢
rs.freeze(secs)	 // å†»ç»“å½“å‰èŠ‚ç‚¹åœ¨æŒ‡å®šçš„æ—¶é—´å†…ï¼ˆç§’ï¼‰ä¸èƒ½é€‰ä¸¾ä¸ºä¸»
rs.syncFrom(hostportstr) 	// ç®¡ç†å‘˜ä¸´æ—¶è¦†ç›–å½“å‰æˆå‘˜çš„é»˜è®¤åŒæ­¥ç›®æ ‡ã€‚ä»¥[hostname]ï¼š[port]çš„å½¢å¼æŒ‡å®šè¦å¤åˆ¶çš„æˆå‘˜çš„åç§°ã€‚
```

#### æµ‹è¯•

æ‰¾åˆ°ä¸»èŠ‚ç‚¹ï¼Œæ’å…¥ä¸€æ¡æ–‡æ¡£ï¼Œç„¶ååœ¨å‰¯æœ¬èŠ‚ç‚¹æŸ¥çœ‹æ•°æ®æ˜¯å¦æˆåŠŸåŒæ­¥

### åˆ†ç‰‡(Sharding)

#### ç®€ä»‹

åœ¨Mongodbé‡Œé¢å­˜åœ¨å¦ä¸€ç§é›†ç¾¤ï¼Œå°±æ˜¯åˆ†ç‰‡æŠ€æœ¯,å¯ä»¥æ»¡è¶³MongoDBæ•°æ®é‡å¤§é‡å¢é•¿çš„éœ€æ±‚ã€‚

å½“MongoDBå­˜å‚¨æµ·é‡çš„æ•°æ®æ—¶ï¼Œä¸€å°æœºå™¨å¯èƒ½ä¸è¶³ä»¥å­˜å‚¨æ•°æ®ï¼Œä¹Ÿå¯èƒ½ä¸è¶³ä»¥æä¾›å¯æ¥å—çš„è¯»å†™ååé‡ã€‚è¿™æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡åœ¨å¤šå°æœºå™¨ä¸Šåˆ†å‰²æ•°æ®ï¼Œä½¿å¾—æ•°æ®åº“ç³»ç»Ÿèƒ½å­˜å‚¨å’Œå¤„ç†æ›´å¤šçš„æ•°æ®ã€‚

![image-20240203232519094](./images.assets/image-20240203232519094.png)

**ä¸ºä»€ä¹ˆä½¿ç”¨åˆ†ç‰‡**

- å¤åˆ¶æ‰€æœ‰çš„å†™å…¥æ“ä½œåˆ°ä¸»èŠ‚ç‚¹
- å»¶è¿Ÿçš„æ•æ„Ÿæ•°æ®ä¼šåœ¨ä¸»èŠ‚ç‚¹æŸ¥è¯¢
- å•ä¸ªå‰¯æœ¬é›†é™åˆ¶åœ¨12ä¸ªèŠ‚ç‚¹
- å½“è¯·æ±‚é‡å·¨å¤§æ—¶ä¼šå‡ºç°å†…å­˜ä¸è¶³ã€‚
- æœ¬åœ°ç£ç›˜ä¸è¶³
- å‚ç›´æ‰©å±•ä»·æ ¼æ˜‚è´µ

**åˆ†ç‰‡é›†ç¾¤èŠ‚ç‚¹**

- è·¯ç”±èŠ‚ç‚¹ (mongos)ï¼šæä¾›é›†ç¾¤å•ä¸€å…¥å£ã€è½¬å‘åº”ç”¨ç«¯è¯·æ±‚ã€é€‰æ‹©åˆé€‚æ•°æ®èŠ‚ç‚¹è¿›è¡Œè¯»å†™ã€åˆå¹¶å¤šä¸ªæ•°æ®èŠ‚ç‚¹çš„è¿”å›
- é…ç½®èŠ‚ç‚¹ (Config Server)ï¼šæ‰€æœ‰å­˜/å–æ•°æ®çš„æ–¹å¼ã€ æ‰€æœ‰shardèŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œåˆ†ç‰‡åŠŸèƒ½çš„ä¸€äº›é…ç½®ä¿¡æ¯
- æ•°æ®èŠ‚ç‚¹ (Shard)ï¼šä»¥å¤åˆ¶é›†ä¸ºå•ä½ã€æ¨ªå‘æ‰©å±•ã€æœ€å¤§1024åˆ†ç‰‡ã€åˆ†ç‰‡ä¹‹é—´æ•°æ®ä¸é‡å¤ã€æ‰€æœ‰åˆ†ç‰‡åœ¨ä¸€èµ·æ‰å¯ä»¥å®Œæ•´å·¥ä½œã€çœŸæ­£çš„æ•°æ®å­˜å‚¨ä½ç½®ï¼Œä»¥chunkä¸ºå•ä½å­˜æ•°æ®

**Chunkä»‹ç»**

åœ¨ä¸€ä¸ªshard serverå†…éƒ¨ï¼ŒMongoDBè¿˜æ˜¯ä¼šæŠŠæ•°æ®åˆ†ä¸ºchunksï¼Œæ¯ä¸ªchunkä»£è¡¨è¿™ä¸ªshard serverå†…éƒ¨ä¸€éƒ¨åˆ†æ•°æ®ã€‚

Chunk ç”¨é€”å¦‚ä¸‹ï¼š

- Splittingï¼šå½“ä¸€ä¸ª chunk çš„å¤§å°è¶…è¿‡é…ç½®ä¸­çš„ chunk size æ—¶ï¼ŒMongoDB çš„åå°è¿›ç¨‹ä¼šæŠŠè¿™ä¸ª chunk åˆ‡åˆ†æˆæ›´å°çš„ chunkï¼Œä»è€Œé¿å… chunk è¿‡å¤§çš„æƒ…å†µ

- Balancingï¼šåœ¨MongoDBä¸­ï¼Œbalancer æ˜¯ä¸€ä¸ªåå°è¿›ç¨‹ï¼Œè´Ÿè´£ chunk çš„è¿ç§»ï¼Œä»è€Œå‡è¡¡å„ä¸ª shard server çš„è´Ÿè½½ï¼Œç³»ç»Ÿåˆå§‹1ä¸ªchunkï¼Œchunk size é»˜è®¤å€¼64Mï¼Œç”Ÿäº§åº“ä¸Šé€‰æ‹©é€‚åˆä¸šåŠ¡çš„ chunk size æ˜¯æœ€å¥½çš„ã€‚MongoDBä¼šè‡ªåŠ¨æ‹†åˆ†å’Œè¿ç§»chunks

chunksizeçš„é€‰æ‹©ï¼šchunkSize è¶Šå°ï¼Œchunk åˆ†è£‚åŠè¿ç§»è¶Šå¤šï¼Œæ•°æ®åˆ†å¸ƒè¶Šå‡è¡¡ï¼›åä¹‹ï¼ŒchunkSize è¶Šå¤§ï¼Œchunk åˆ†è£‚åŠè¿ç§»ä¼šæ›´å°‘ï¼Œä½†å¯èƒ½å¯¼è‡´æ•°æ®åˆ†å¸ƒä¸å‡

**æ•°æ®åŒºåˆ†**

åˆ†ç‰‡é”®ï¼ˆshard keyï¼‰:MongoDB ä¸­æ•°æ®çš„åˆ†ç‰‡æ˜¯ä»¥é›†åˆä¸ºåŸºæœ¬å•ä½çš„ï¼Œé›†åˆä¸­çš„æ•°æ®é€šè¿‡ç‰‡é”®ï¼ˆShard keyï¼‰è¢«åˆ†æˆå¤šéƒ¨åˆ†

åˆ†ç‰‡é”®ç‰¹ç‚¹

- åˆ†ç‰‡é”®å¿…é¡»æ˜¯ä¸€ä¸ªç´¢å¼•
- åˆ†ç‰‡é”®æ˜¯ä¸å¯å˜
- åˆ†ç‰‡é”®å¤§å°é™åˆ¶512bytes
- åˆ†ç‰‡é”®ç”¨äºè·¯ç”±æŸ¥è¯¢

åˆ†ç‰‡é”®é€‰æ‹©å»ºè®®

- é€’å¢çš„sharding keyï¼šä¼˜ç‚¹æ˜¯æ•°æ®æ–‡ä»¶æŒªåŠ¨å°ã€‚
- éšæœºçš„sharding keyï¼šä¼˜ç‚¹æ˜¯æ•°æ®åˆ†å¸ƒå‡åŒ€ï¼Œinsertçš„å†™IOå‡åŒ€åˆ†å¸ƒåœ¨å¤šä¸ªç‰‡ä¸Š
- æ··åˆå‹sharding keyï¼šå¤§æ–¹å‘éšæœºé€’å¢ï¼Œå°èŒƒå›´éšæœºåˆ†å¸ƒã€‚

ä¸ºäº†é˜²æ­¢å‡ºç°å¤§é‡çš„chunkå‡è¡¡è¿ç§»ï¼Œå¯èƒ½é€ æˆçš„IOå‹åŠ›ã€‚æˆ‘ä»¬éœ€è¦è®¾ç½®åˆç†åˆ†ç‰‡ä½¿ç”¨ç­–ç•¥ï¼ˆç‰‡é”®çš„é€‰æ‹©ã€åˆ†ç‰‡ç®—æ³•ï¼ˆrangeã€hashï¼‰ï¼‰

#### æ­å»º

>mongoséœ€è¦å•ç‹¬å®‰è£…ï¼Œ[Download MongoDB Community Server | MongoDB](https://www.mongodb.com/try/download/community-kubernetes-operator)ä¸‹è½½ mongosï¼Œç„¶åå®‰è£…

![image-20240204194650772](./images.assets/image-20240204194650772.png)

æœ¬åœ°éƒ¨ç½²ä¸¤ä¸ªShardï¼ˆå‰¯æœ¬é›†ï¼Œæ¯ä¸ªå‰¯æœ¬é›†ä¸­åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼‰ã€ä¸€ä¸ªé…ç½®èŠ‚ç‚¹ï¼ˆconfig serverï¼‰ã€ä¸€ä¸ª è·¯ç”±èŠ‚ç‚¹ï¼ˆmongosï¼‰

```js
/*
    Shard
        shardSet1 : ä¸€ä¸ªå®ä¾‹ï¼Œç«¯å£ 30001
        shardSet2 : ä¸€ä¸ªå®ä¾‹ï¼Œç«¯å£ 30002

    config server
        configRs : ä¸€ä¸ªå®ä¾‹ï¼Œç«¯å£30011

    mongos ç«¯å£ 30021
*/
```

1. éƒ¨ç½²å‰¯æœ¬é›† shardSet1

   ```bash
   ## --shardsvr æŒ‡å®šè¯¥å®ä¾‹æ˜¯ä¸€ä¸ª shard
   mongod --bind_ip_all --port "30001" --dbpath "/root/mongodb/shard/shard1" -logpath "/root/mongodb/shard/log/shard11.log" --replSet shardSet1 --shardsvr --fork
   ```

   åˆå§‹åŒ–å‰¯æœ¬é›†

   ```js
   // åˆ‡æ¢æ•°æ®åº“
   use admin
   // ä½¿ç”¨ipåœ°å€ï¼Œä¸ç„¶åç»­ mongos æ·»åŠ  shard æ—¶ä¼šæŠ¥é”™ï¼ˆ7.0.5ç‰ˆæœ¬ï¼‰
   rs.initiate({
   	"_id":"shardSet1",
   	"members":[
   		{"_id" : 0, "host" : "192.168.56.101:30001"}
   	]
   })
   ```

2. éƒ¨ç½²å‰¯æœ¬é›† shardSet2

   ```bash
   mongod --bind_ip_all --port "30002" --dbpath "/root/mongodb/shard/shard2" -logpath "/root/mongodb/shard/log/shard12.log" --replSet shardSet2 --shardsvr --fork
   ```

   åˆå§‹åŒ–å‰¯æœ¬é›†

   ```js
   use admin
   rs.initiate({
   	"_id":"shardSet2",
   	"members":[
   		{"_id" : 1, "host" : "192.168.56.101:30002"}
   	]
   })
   ```

3. éƒ¨ç½² Config Server

   ```bash
   mongod --bind_ip_all --port "30011" --dbpath "/root/mongodb/shard/config" -logpath "/root/mongodb/shard/log/config.log" --replSet configRs --configsvr --fork
   ```

   åˆå§‹åŒ–å‰¯æœ¬é›†

   ```js
   use admin
   rs.initiate({
   	"_id":"configRs",
   	"members":[
   		{"_id" : 0, "host" : "192.168.56.101:30011"}
   	]
   })
   ```

4. å¯åŠ¨ï¼ˆå¯èƒ½éœ€è¦å•ç‹¬ä¸‹è½½ï¼‰mongos

   ```bash
   ## æŒ‡å®š config server å¯åŠ¨ mongos
   mongos --bind_ip_all --port "30021" -logpath "/root/mongodb/shard/log/route.log" --configdb "configRs/localhost:30011" --fork
   ```

   è¿æ¥ mongosï¼Œæ·»åŠ  shard

   ```js
   // sh.addShard('<replSetName>/ip:port,ip:port...')
   
   // æ·»åŠ  shard shardSet1
   sh.addShard('shardSet1/192.168.56.101:30001')
   
   // æ·»åŠ  shard shardSet1
   sh.addShard('shardSet2/192.168.56.101:30002')
   
   // æŸ¥çœ‹åˆ†ç‰‡çŠ¶æ€
   sh.status()
   ```

#### æµ‹è¯•

```js
// åˆ›å»ºæ•°æ®åº“
use mydb

// åˆ›å»ºé›†åˆ
db.createCollection('testcollection')

// å¯¹ç‰‡é”®çš„å­—æ®µå»ºç«‹ç´¢å¼• db.<collection>.createIndex(<keyPatterns>,<options>) 
// ä¸‹ä¾‹å­åˆ›å»ºäº†å“ˆå¸Œç´¢å¼•
db.testcollection.createIndex({title:'hashed'})

// sh.shardCollection("<database>.<collection>",{ "<key>":<value> } ) 
// ä¸‹ä¾‹å­è¡¨ç¤ºå°†æ•°æ®åŸºäºå“ˆå¸Œåˆ†ç‰‡
sh.shardCollection("mydb.testcollection",{"title":'hashed'})

// æ’å…¥æµ‹è¯•æ•°æ®
db.testcollection.insertMany([
	{title:1},
	{title:-1},
	{title:3},
	{title:-3},
	{title:5},
	{title:-5}
])

// æŸ¥çœ‹åˆ†ç‰‡çŠ¶æ€ï¼Œè¿”å› åˆ†ç‰‡ä¿¡æ¯ï¼Œåˆ†ç‰‡çš„é›†åˆï¼Œåˆ†ç‰‡çš„keyï¼Œç‰‡é”®ï¼ŒåŸºäºä»€ä¹ˆåˆ†ç‰‡ï¼ˆhash/èŒƒå›´ï¼‰ï¼Œå½“å‰çš„chunks
sh.status()
```

## mongoDB java

### æ­å»º

å¯åŠ¨ mongoDB å‰¯æœ¬é›†

```bash
## å¯åŠ¨å‘½ä»¤
mongod --bind_ip_all --port "30001" --dbpath "/root/mongodb/replSet/rs1" -logpath "/root/mongodb/replSet/rs1.log" --replSet "replSet" --fork
mongod --bind_ip_all --port "30002" --dbpath "/root/mongodb/replSet/rs2" -logpath "/root/mongodb/replSet/rs2.log" --replSet "replSet" --fork
mongod --bind_ip_all --port "30003" --dbpath "/root/mongodb/replSet/rs3" -logpath "/root/mongodb/replSet/rs3.log" --replSet "replSet" --fork
```

åˆå§‹åŒ–å‰¯æœ¬é›†

```js
// è¿æ¥ä»»æ„èŠ‚ç‚¹åˆå§‹åŒ–å‰¯æœ¬é›†
// arbiterOnly ä»²è£èŠ‚ç‚¹ï¼Œä¸å‚ä¸æ•°æ®çš„å¤åˆ¶ï¼Œä»…é€‰ä¸¾ master èŠ‚ç‚¹
rs.initiate({
	"_id":"replSet",
	"members":[
		{"_id" : 0, "host" : "192.168.56.101:30001"},
		{"_id" : 1, "host" : "192.168.56.101:30002"},
		{"_id" : 2, "host" : "192.168.56.101:30003","arbiterOnly":true}
	]
})

// åˆ‡æ¢æ•°æ®åº“
use myDB

// æ’å…¥æµ‹è¯•æ•°æ®
db.testCollection.insertMany([
	{name:'å¼ ä¸‰',title:'æµ‹è¯•1',age:22},
	{name:'æå››',title:'æµ‹è¯•2',age:24},
	{name:'ç‹äº”',title:'æµ‹è¯•3',age:29}
])

// æŸ¥è¯¢æ•°æ®
db.testCollection.find({})
```

### java ä¸­åŸºæœ¬æ“ä½œ

```java
public class CH05MongoDBDemo {
    public static void main(String[] args) {
        ConnectionString connectionString=new ConnectionString("mongodb://192.168.56.101:30001,192.168.56.101:30002/?replicaSet=replSet");
        try (MongoClient mongoClient = MongoClients.create(connectionString)) {
            MongoDatabase database = mongoClient.getDatabase("myDB");
            MongoCollection<Document> collection = database.getCollection("testCollection");

            // æ’å…¥æ•°æ®
//            insertMethod(collection);

            // æŸ¥è¯¢æ•°æ®
//            findMethod(collection);

            // æ›´æ–°æ•°æ®
//            updateMethod(collection);

            // åˆ é™¤æ•°æ®
//            deleteMethod(collection);

            // åˆ†é¡µæŸ¥è¯¢
            pageMethod(collection);

        }

    }

    private static void pageMethod(MongoCollection<Document> collection) {
        final int pageSize=2;
        final int pageIndex=2;
        FindIterable<Document> documentFindIterable = collection.find();

        // é€šè¿‡ age å‡åºæ’åº
        documentFindIterable.sort(Document.parse("{age:-1}"));

        documentFindIterable.limit(pageSize);
        documentFindIterable.skip(pageIndex*(pageSize-1));

        MongoCursor<Document> iterator = documentFindIterable.iterator();
        while (iterator.hasNext()){
            System.out.println(iterator.next().toJson());
        }
    }

    private static void deleteMethod(MongoCollection<Document> collection) {
        Document query = Document.parse("{name:'å¼ ä¸‰'}");
        DeleteResult deleteResult = collection.deleteOne(query);
        System.out.println(deleteResult.wasAcknowledged());
    }

    private static void updateMethod(MongoCollection<Document> collection) {
        Document query = Document.parse("{name:'å¼ ä¸‰'}");
        Bson bson = Updates.combine(
                Updates.set("age", 66)
        );

        UpdateResult updateResult = collection.updateOne(query, bson);

        System.out.println(updateResult.wasAcknowledged());
    }

    private static void findMethod(MongoCollection<Document> collection) {
        FindIterable<Document> documentFindIterable = collection.find();
        MongoCursor<Document> iterator = documentFindIterable.iterator();
        while (iterator.hasNext()){
            System.out.println(iterator.next().toJson());
        }

    }

    private static void insertMethod(MongoCollection<Document> collection) {
        List<Document> documentList=new ArrayList<>();
        documentList.add(Document.parse("{name:'å¼ ä¸‰',title:'æµ‹è¯•1',age:22}"));
        documentList.add(Document.parse("{name:'æå››',title:'æµ‹è¯•2',age:24}"));
        documentList.add(Document.parse("{name:'ç‹äº”',title:'æµ‹è¯•3',age:29}"));
        InsertManyResult result = collection.insertMany(documentList);
        System.out.println(result.wasAcknowledged());
    }
}
```





